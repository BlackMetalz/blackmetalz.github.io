<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="/theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="author" content="kienlt" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="kyverno, certification, linux-foundation, kca, Knowledge Base, " />

<meta property="og:title" content="Prepare for the Kyverno Certified Associate (KCA) exam "/>
<meta property="og:url" content="/prepare-for-the-kyverno-certified-associate-kca-exam.html" />
<meta property="og:description" content="" />
<meta property="og:site_name" content="Kienlt&#39;s notebook" />
<meta property="og:article:author" content="kienlt" />
<meta property="og:article:published_time" content="2025-12-18T00:00:00+07:00" />
<meta name="twitter:title" content="Prepare for the Kyverno Certified Associate (KCA) exam ">
<meta name="twitter:description" content="">

        <title>Prepare for the Kyverno Certified Associate (KCA) exam  · Kienlt&#39;s notebook
</title>



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="/"><span class=site-name>Kienlt's notebook</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       "/"
                                    >Home</a>
                                </li>
                                <li ><a href="/categories.html">Categories</a></li>
                                <li ><a href="/tags.html">Tags</a></li>
                                <li ><a href="/archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="/prepare-for-the-kyverno-certified-associate-kca-exam.html">
                Prepare for the Kyverno Certified Associate (KCA) exam
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <p><img alt="alt text" src="images/2025/12/18.png"></p>
<h1>Kyverno Overview: The "Kubernetes Native" Policy Engine</h1>
<p>If you are preparing for the KCA (Kyverno Certified Associate) exam or just getting started with policy-as-code, you need to grasp the core concepts before diving into the syntax. Here is the high-level overview.</p>
<h3>1. What is Kyverno? (Keyword: Kubernetes Native)</h3>
<p>Kyverno is the engine (Controller), and <code>ClusterPolicy</code>/<code>Policy</code> are the configuration formats (CRDs) that it uses.</p>
<p>Unlike OPA Gatekeeper (which requires learning the complex Rego language), Kyverno is Kubernetes Native.</p>
<ul>
<li>The Key Differentiator: Policies are written in standard YAML. If you can read Kubernetes manifests (Deployment, Service, etc.), you can understand Kyverno policies immediately.</li>
<li>Role: It acts as a "Gatekeeper" (Admission Controller) sitting right at the API Server door.</li>
</ul>
<h3>2. Core Logic (How it works)</h3>
<p>When you execute <code>kubectl apply -f pod.yaml</code>, the flow is as follows:</p>
<ul>
<li>The request hits the API Server.</li>
<li>Kyverno (acting as a Webhook) intercepts the request.</li>
<li>It checks if the request matches any defined Policy.</li>
<li>If matched, it executes one of the 4 main actions (this is the backbone of the KCA exam):</li>
</ul>
<h3>3. Key Capabilities (The 4 Pillars)</h3>
<p>Validation (Most Common)</p>
<ul>
<li>Goal: "Allowed" or "Denied".</li>
<li>Example: A Pod must have the label team: dev. If missing -&gt; Block (Enforce) or Warn (Audit).</li>
</ul>
<p>Mutation (Modify)</p>
<ul>
<li>Goal: Modify the YAML content before it is persisted to the database (etcd).</li>
<li>Example: A user creates a Pod but forgets the imagePullPolicy. Kyverno automatically injects imagePullPolicy: Always.</li>
</ul>
<p>Generation (Create New) - The "Killer Feature"</p>
<ul>
<li>Goal: Automatically generate additional resources based on a trigger.</li>
<li>Example: When a new Namespace is created -&gt; Kyverno automatically generates a default NetworkPolicy and ResourceQuota inside that Namespace.</li>
</ul>
<p>Verify Images (Supply Chain Security)</p>
<ul>
<li>Goal: Check container image signatures.</li>
<li>Example: Only allow images signed by the company's private key (integrates with Cosign/Sigstore)</li>
</ul>
<h3>4. Anatomy of a Policy</h3>
<p>A basic Policy file follows this nested structure:</p>
<ul>
<li>Policy / ClusterPolicy:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">Policy</span><span class="o">:</span><span class="w"> </span><span class="n">Scoped</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">specific</span><span class="w"> </span><span class="n">Namespace</span><span class="o">.</span>
<span class="n">ClusterPolicy</span><span class="o">:</span><span class="w"> </span><span class="n">Applied</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">entire</span><span class="w"> </span><span class="n">cluster</span><span class="w"> </span><span class="o">(</span><span class="n">Global</span><span class="o">).</span>
</code></pre></div>

<ul>
<li>Rules: A Policy can contain multiple Rules</li>
<li>Match / Exclude: Selects the resources to target (e.g., match all Pods, exclude Pods in kube-system).</li>
<li>Action: What to do (validate, mutate, generate, verifyImages).</li>
</ul>
<p>Quick YAML Structure Example:</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kyverno.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">require-labels</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">validationFailureAction</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Enforce</span><span class="w"> </span><span class="c1"># Enforce (Block) or Audit (Log report)</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">check-team-label</span>
<span class="w">    </span><span class="nt">match</span><span class="p">:</span>
<span class="w">      </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">        </span><span class="nt">kinds</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"> </span><span class="c1"># Apply to Pods</span>
<span class="w">    </span><span class="nt">validate</span><span class="p">:</span><span class="w"> </span><span class="c1"># Validation Action</span>
<span class="w">      </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;The</span><span class="nv"> </span><span class="s">&#39;team&#39;</span><span class="nv"> </span><span class="s">label</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">required!&quot;</span>
<span class="w">      </span><span class="nt">pattern</span><span class="p">:</span>
<span class="w">        </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">          </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">            </span><span class="nt">team</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;?*&quot;</span><span class="w"> </span><span class="c1"># Check for existence</span>
</code></pre></div>

<h3>5. Exam Tips (Must Know)</h3>
<p>Models: </p>
<ul>
<li>Audit: Violations are allowed but logged in a PolicyReport. This is the safe default for Production to avoid breaking existing workflows.</li>
<li>Enforce: Violations are blocked immediately (Deny).</li>
</ul>
<p>JMESPath: Kyverno uses JMESPath for logic processing (handling if/else, contains, sum, etc.). Expect questions on filtering JSON data using JMESPath.</p>
<p>Auto-gen Rules: If you write a rule for Pod, Kyverno is smart enough to automatically generate rules for Deployment, StatefulSet, DaemonSet, etc. (unless you explicitly disable this feature).</p>
<p>Summary: Kyverno is an Admission Controller that uses YAML to Validate, Mutate, Generate resources, and Verify Images.</p>
<hr>
<h1>Sections need to be understood</h1>
<h3>Kyverno Match/Exclude</h3>
<p>Purpose: Identifying and filtering resources for rule evaluation.</p>
<p>Basic Structure:</p>
<div class="highlight"><pre><span></span><code><span class="nt">match</span><span class="p">:</span>
<span class="w">  </span><span class="nt">any</span><span class="p">:</span><span class="w">   </span><span class="c1"># OR logic - satisfy at least one condition</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kinds</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">...</span><span class="p p-Indicator">]</span><span class="w">        </span><span class="c1"># REQUIRED</span>
<span class="w">      </span><span class="nt">names</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">...</span><span class="p p-Indicator">]</span><span class="w">        </span><span class="c1"># Optional</span>
<span class="w">      </span><span class="nt">namespaces</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">...</span><span class="p p-Indicator">]</span><span class="w">   </span><span class="c1"># Optional</span>
<span class="w">      </span><span class="nt">operations</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">...</span><span class="p p-Indicator">]</span><span class="w">   </span><span class="c1"># Optional (default: CREATE, UPDATE)</span>
<span class="w">      </span><span class="nt">selector</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nv">...</span><span class="p p-Indicator">}</span><span class="w">     </span><span class="c1"># Optional (label selector)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="nt">match</span><span class="p">:</span>
<span class="w">  </span><span class="nt">all</span><span class="p">:</span><span class="w">   </span><span class="c1"># AND logic - must satisfy ALL conditions</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kinds</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">...</span><span class="p p-Indicator">]</span>
</code></pre></div>

<p>Example Match Pod or Deployment with specific label: Applies to Deployment OR StatefulSet with label <code>app=critical</code></p>
<div class="highlight"><pre><span></span><code><span class="nt">match</span><span class="p">:</span>
<span class="w">  </span><span class="nt">any</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kinds</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">StatefulSet</span>
<span class="w">      </span><span class="nt">operations</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CREATE</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">UPDATE</span>
<span class="w">      </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">        </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
</code></pre></div>

<p>Exclude specific namespace: Applies to ALL Pods EXCEPT those in <code>prod-alpha</code> namespace</p>
<div class="highlight"><pre><span></span><code><span class="nt">match</span><span class="p">:</span>
<span class="w">  </span><span class="nt">any</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kinds</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">exclude</span><span class="p">:</span>
<span class="w">  </span><span class="nt">any</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">      </span><span class="nt">namespaces</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prod-alpha</span>
</code></pre></div>

<p>Match by namespace label: Only applies to Deployments in namespaces with label <code>type=connector</code> or <code>type=compute</code></p>
<div class="highlight"><pre><span></span><code><span class="nt">match</span><span class="p">:</span>
<span class="w">  </span><span class="nt">any</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kinds</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="w">      </span><span class="nt">namespaceSelector</span><span class="p">:</span>
<span class="w">        </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type</span>
<span class="w">          </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<span class="w">          </span><span class="nt">values</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">connector</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">compute</span>
</code></pre></div>

<p>Exclude user/role: Applies to Pods with label <code>app=critical</code> EXCEPT those created by <code>cluster-admin</code> or user <code>John</code></p>
<div class="highlight"><pre><span></span><code><span class="nt">match</span><span class="p">:</span>
<span class="w">  </span><span class="nt">any</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kinds</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="w">      </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">        </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
<span class="nt">exclude</span><span class="p">:</span>
<span class="w">  </span><span class="nt">any</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">clusterRoles</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster-admin</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">subjects</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">User</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">John</span>
</code></pre></div>

<p>Important Logic:</p>
<p>Within resources block:</p>
<ul>
<li>AND across types (kinds AND namespaces)</li>
<li>OR within lists (Pod OR Deployment)</li>
</ul>
<p>Between match and exclude: AND logic (must satisfy match AND not satisfy exclude)</p>
<p>Tips:</p>
<ul>
<li>operations is optional, defaults to [CREATE, UPDATE]</li>
<li>Wildcards * supported in kinds, names, namespaces</li>
<li>Use any: for OR logic, all: for AND logic</li>
<li>exclude must be a subset of match</li>
</ul>
<h3>request.object Variable</h3>
<p>Documentation: https://kyverno.io/docs/policy-types/cluster-policy/variables/</p>
<p>What is request.object? </p>
<p><code>request.object</code> is the incoming resource configuration (the new state) that is being submitted to Kubernetes API server.</p>
<p>Practical Example 1 - Access resource name: If you create namespace </p>
<p><code>prod</code> -&gt; <code>{{request.object.metadata.name}}</code> = <code>"prod"</code></p>
<div class="highlight"><pre><span></span><code><span class="nt">validate</span><span class="p">:</span>
<span class="w">  </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Creating</span><span class="nv"> </span><span class="s">namespace:</span><span class="nv"> </span><span class="s">{{request.object.metadata.name}}&quot;</span>
<span class="w">  </span><span class="nt">pattern</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">team</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;?*&quot;</span>
</code></pre></div>

<p>Practical Example 2 - Generate Secret in new namespace: When creating namespace <code>staging</code> -&gt; Secret is generated in <code>staging</code> namespace</p>
<div class="highlight"><pre><span></span><code><span class="nt">generate</span><span class="p">:</span>
<span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">regcred</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{request.object.metadata.name}}&quot;</span><span class="w">  </span><span class="c1"># Uses incoming namespace name</span>
<span class="w">  </span><span class="nt">clone</span><span class="p">:</span>
<span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">regcred</span>
</code></pre></div>

<p>Practical Example 3 - Validate based on labels: Only runs if the incoming resource has label <code>app=critical</code></p>
<div class="highlight"><pre><span></span><code><span class="nt">preconditions</span><span class="p">:</span>
<span class="w">  </span><span class="nt">any</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{request.object.metadata.labels.app}}&quot;</span>
<span class="w">    </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Equals</span>
<span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;critical&quot;</span>
</code></pre></div>

<p>Quick Comparison:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># User submits this Pod:</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx:1.20</span>
</code></pre></div>

<ul>
<li><code>{{request.object.metadata.name}}</code> -&gt; <code>"nginx"</code></li>
<li><code>{{request.object.metadata.labels.app}}</code> -&gt; <code>"web"</code></li>
<li><code>{{request.object.spec.containers[0].image}}</code> -&gt; <code>"nginx:1.20"</code></li>
</ul>
<h3>What is <code>JMESPath</code> used for in Kyverno?</h3>
<p>In Kyverno, <strong>JMESPath</strong> (pronounced "James Path") is a JSON query language used to <strong>select, filter, and transform</strong> data from Kubernetes resources.</p>
<p>Think of it as the logic layer that allows your policies to "read" and "process" YAML manifests.</p>
<p>It is primarily used for:</p>
<ul>
<li><strong>Variable Substitution:</strong> Extracting values from a request to use elsewhere (e.g., getting a namespace name: <code>{{ request.object.metadata.namespace }}</code>).</li>
<li><strong>Condition Logic:</strong> Writing complex <code>preconditions</code> to decide if a rule should run (e.g., "only run this if the image tag is NOT 'latest'").</li>
<li><strong>Filtering:</strong> Selecting specific items from arrays (e.g., "find all containers that have port 80 open").</li>
<li><strong>Data Transformation:</strong> Modifying data formats before validation or mutation.</li>
</ul>
<p><strong>Example:</strong>
To check if a label exists, you might use a JMESPath expression like:
<code>contains(request.object.metadata.labels, 'production')</code></p>
<p>Let's go for scenario:</p>
<ul>
<li>We want to enforce a rule that says: "If a Pod has the label env set to production, it must also include a contact-email annotation."</li>
<li>We use the JMESPath contains function in the preconditions block to target only specific resources.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kyverno.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">require-annotation-for-production</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">validationFailureAction</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Enforce</span>
<span class="w">  </span><span class="nt">background</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">check-production-annotation</span>
<span class="w">      </span><span class="nt">match</span><span class="p">:</span>
<span class="w">        </span><span class="nt">any</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">            </span><span class="nt">kinds</span><span class="p">:</span>
<span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>

<span class="w">      </span><span class="c1"># 1. PRECONDITIONS: The JMESPath Logic</span>
<span class="w">      </span><span class="c1"># This block ensures the rule ONLY runs if the label &#39;env&#39; contains &#39;production&#39;</span>
<span class="w">      </span><span class="nt">preconditions</span><span class="p">:</span>
<span class="w">        </span><span class="nt">all</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">          </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Equals</span>
<span class="w">          </span><span class="c1"># Note: In JMESPath, `contains` returns true/false. </span>
<span class="w">          </span><span class="c1"># We check if the &#39;env&#39; label value contains the string &#39;production&#39;.</span>
<span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">contains(request.object.metadata.labels.env</span><span class="nv"> </span><span class="s">||</span><span class="nv"> </span><span class="s">&#39;&#39;,</span><span class="nv"> </span><span class="s">&#39;production&#39;)</span><span class="nv"> </span><span class="s">}}&quot;</span>

<span class="w">      </span><span class="c1"># 2. VALIDATION: The actual check to enforce</span>
<span class="w">      </span><span class="nt">validate</span><span class="p">:</span>
<span class="w">        </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Production</span><span class="nv"> </span><span class="s">pods</span><span class="nv"> </span><span class="s">must</span><span class="nv"> </span><span class="s">have</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">&#39;contact-email&#39;</span><span class="nv"> </span><span class="s">annotation.&quot;</span>
<span class="w">        </span><span class="nt">pattern</span><span class="p">:</span>
<span class="w">          </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">            </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">              </span><span class="nt">contact-email</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;?*&quot;</span>
</code></pre></div>

<p>This will be blocked</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bad-prod-pod</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</code></pre></div>

<p>This will be allowed</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dev-pod</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">development</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</code></pre></div>

<h3>What is PolicyReport?</h3>
<p>The PolicyReport is essentially a "Health Check Report Card" for your Kubernetes resources.</p>
<p>While ClusterPolicy defines the rules, the PolicyReport stores the results of those rules.</p>
<p>Purpose of PolicyReport: Its main goal is Observability &amp; Auditing.</p>
<p>Without PolicyReports, if a policy is set to Audit mode (non-blocking), you would have no easy way to know which resources are violating rules—you would have to dig through Kyverno controller logs.</p>
<ul>
<li>Audit Results: It lists resources that exist in your cluster but violate a policy.</li>
<li>Standardization: It is not unique to Kyverno! It is a standard CRD defined by the Kubernetes Policy Working Group (WG-Policy). This means other tools (like Falco, Trivy, or UI Dashboards) can also read/write these reports.</li>
<li>Scoping: It keeps results close to the application. Developers can check <code>kubectl get policyreport -n my-app</code> to see if their app is compliant, without needing cluster-admin access.</li>
</ul>
<p>Example output of command get policyreport:</p>
<div class="highlight"><pre><span></span><code>NAME              PASS   FAIL   WARN   ERROR   SKIP   AGE
polr-ns-default   0      1      0      0       0      5m
</code></pre></div>

<p>The PolicyReport YAML output of command: <code>kubectl get policyreport -n my-app polr-ns-default -oyaml</code></p>
<div class="highlight"><pre><span></span><code><span class="n">apiVersion</span><span class="o">:</span><span class="w"> </span><span class="n">wgpolicyk8s</span><span class="o">.</span><span class="na">io</span><span class="o">/</span><span class="n">v1alpha2</span>
<span class="n">kind</span><span class="o">:</span><span class="w"> </span><span class="n">PolicyReport</span>
<span class="n">metadata</span><span class="o">:</span>
<span class="w">  </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">polr</span><span class="o">-</span><span class="n">ns</span><span class="o">-</span><span class="k">default</span>
<span class="w">  </span><span class="kd">namespace</span><span class="o">:</span><span class="w"> </span><span class="k">default</span><span class="w">   </span><span class="err">#</span><span class="w"> </span><span class="n">It</span><span class="w"> </span><span class="n">lives</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Pod</span><span class="o">,</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">cluster</span><span class="w"> </span><span class="n">level</span>
<span class="w">  </span><span class="n">labels</span><span class="o">:</span>
<span class="w">    </span><span class="n">app</span><span class="o">.</span><span class="na">kubernetes</span><span class="o">.</span><span class="na">io</span><span class="o">/</span><span class="n">managed</span><span class="o">-</span><span class="n">by</span><span class="o">:</span><span class="w"> </span><span class="n">kyverno</span>
<span class="n">summary</span><span class="o">:</span>
<span class="w">  </span><span class="n">pass</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="n">fail</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="n">warn</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="n">error</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="n">skip</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span>
<span class="n">results</span><span class="o">:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">policy</span><span class="o">:</span><span class="w"> </span><span class="n">require</span><span class="o">-</span><span class="n">labels</span><span class="w">           </span><span class="err">#</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">ClusterPolicy</span><span class="w"> </span><span class="n">responsible</span>
<span class="w">    </span><span class="n">rule</span><span class="o">:</span><span class="w"> </span><span class="n">check</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="n">team</span><span class="o">-</span><span class="n">label</span><span class="w">       </span><span class="err">#</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">specific</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="n">name</span>
<span class="w">    </span><span class="n">category</span><span class="o">:</span><span class="w"> </span><span class="n">Best</span><span class="w"> </span><span class="n">Practices</span>
<span class="w">    </span><span class="n">severity</span><span class="o">:</span><span class="w"> </span><span class="n">medium</span>
<span class="w">    </span><span class="n">result</span><span class="o">:</span><span class="w"> </span><span class="n">fail</span><span class="w">                     </span><span class="err">#</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">outcome</span><span class="w"> </span><span class="o">(</span><span class="n">fail</span><span class="o">,</span><span class="w"> </span><span class="n">pass</span><span class="o">,</span><span class="w"> </span><span class="n">warn</span><span class="o">,</span><span class="w"> </span><span class="n">error</span><span class="o">,</span><span class="w"> </span><span class="n">skip</span><span class="o">)</span>
<span class="w">    </span><span class="n">message</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Validation error: label &#39;team&#39; is required&quot;</span><span class="w"> </span>
<span class="w">    </span><span class="n">source</span><span class="o">:</span><span class="w"> </span><span class="n">kyverno</span>
<span class="w">    </span><span class="n">resources</span><span class="o">:</span><span class="w">                       </span><span class="err">#</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">specific</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">failed</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">apiVersion</span><span class="o">:</span><span class="w"> </span><span class="n">v1</span>
<span class="w">        </span><span class="n">kind</span><span class="o">:</span><span class="w"> </span><span class="n">Pod</span>
<span class="w">        </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">nginx</span>
<span class="w">        </span><span class="kd">namespace</span><span class="o">:</span><span class="w"> </span><span class="k">default</span>
<span class="w">        </span><span class="n">uid</span><span class="o">:</span><span class="w"> </span><span class="n">a1b2c3d4</span><span class="o">-</span><span class="n">e5f6</span><span class="o">...</span>
</code></pre></div>

<h3>Validate Rules</h3>
<p>This field sits directly under the spec section of your Policy.</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kyverno.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">disallow-latest-tag</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1"># THIS IS THE FIELD</span>
<span class="w">  </span><span class="c1"># Options: </span>
<span class="w">  </span><span class="c1">#   - Enforce (BLOCK the request)</span>
<span class="w">  </span><span class="c1">#   - Audit   (ALLOW the request, but report it as a fail)</span>
<span class="w">  </span><span class="c1"># ---------------------------------------------------------</span>
<span class="w">  </span><span class="nt">validationFailureAction</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Enforce</span>

<span class="w">  </span><span class="nt">background</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">require-image-tag</span>
<span class="w">      </span><span class="nt">match</span><span class="p">:</span>
<span class="w">        </span><span class="nt">any</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">            </span><span class="nt">kinds</span><span class="p">:</span>
<span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="w">      </span><span class="nt">validate</span><span class="p">:</span>
<span class="w">        </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Using</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">&#39;:latest&#39;</span><span class="nv"> </span><span class="s">tag</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">not</span><span class="nv"> </span><span class="s">allowed.&quot;</span>
<span class="w">        </span><span class="nt">pattern</span><span class="p">:</span>
<span class="w">          </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">            </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;!*:latest&quot;</span>
</code></pre></div>

<p>Important Note on Scoping: You can also set this field per rule if you want mixed behaviors in a single policy (available in newer Kyverno versions):</p>
<div class="highlight"><pre><span></span><code><span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">validationFailureAction</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Audit</span><span class="w">  </span><span class="c1"># Default for the whole policy</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical-rule</span>
<span class="w">      </span><span class="nt">validationFailureAction</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Enforce</span><span class="w"> </span><span class="c1"># This specific rule will BLOCK</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">minor-rule</span>
<span class="w">      </span><span class="c1"># Inherits Audit (ALLOW)</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>

<p>Example: What happens in "Audit" mode</p>
<p>You apply a "bad" Pod.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>bad-pod.yaml
pod/bad-pod<span class="w"> </span>created<span class="w">   </span>&lt;--<span class="w"> </span>Look!<span class="w"> </span>It<span class="w"> </span>says<span class="w"> </span>created.
</code></pre></div>

<p>Kubernetes API Audit Log (file):</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;verb&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;create&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;kubernetes-admin&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;objectRef&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;resource&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pods&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;bad-pod&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;responseStatus&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;code&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">201</span><span class="w"> </span><span class="p">}</span><span class="w">  </span><span class="err">&lt;</span><span class="mi">--</span><span class="w"> </span><span class="err">Success!</span><span class="w"> </span><span class="err">No</span><span class="w"> </span><span class="err">me</span><span class="kc">nt</span><span class="err">io</span><span class="kc">n</span><span class="w"> </span><span class="err">o</span><span class="kc">f</span><span class="w"> </span><span class="err">error.</span>
<span class="p">}</span>
</code></pre></div>

<p>Kyverno Policy Report (Where the truth is):</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>policyreports
NAME<span class="w">              </span>FAIL
polr-ns-default<span class="w">   </span><span class="m">1</span><span class="w">     </span>&lt;--<span class="w"> </span>Here<span class="w"> </span>is<span class="w"> </span>your<span class="w"> </span>violation<span class="w"> </span>log.
</code></pre></div>

<p>So, simple summary:</p>
<ul>
<li><code>Enforce</code>: Stops the bad thing from entering.</li>
<li><code>Audit</code>: Lets the bad thing in, but writes a ticket (PolicyReport) so you can fix it later. It does not rely on the standard API Server audit log for reporting violations.</li>
</ul>
<h3>Background Scans</h3>
<p>Document: https://kyverno.io/docs/policy-reports/background/</p>
<p>It's purpose: Periodically checking existing resources in the cluster against policies to detect violations. It will just create a ticket (PolicyReport).</p>
<p>By default, Kyverno never deletes an existing resource during a Background Scan, even if your policy is set to <code>Enforce</code>. This is a safety mechanism to prevent accidentally killing production workloads.</p>
<p>What if I want to delete pods that violated policies?
You will need Cleanup policy: https://kyverno.io/docs/policy-types/cleanup-policy/</p>
<p>Example: "Delete any Pod older than 7 days"</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kyverno.io/v2beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterCleanupPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cleanup-old-pods</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">match</span><span class="p">:</span>
<span class="w">    </span><span class="nt">any</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">        </span><span class="nt">kinds</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="w">  </span><span class="nt">conditions</span><span class="p">:</span>
<span class="w">    </span><span class="nt">all</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">time_since(&#39;&#39;,</span><span class="nv"> </span><span class="s">request.object.metadata.creationTimestamp,</span><span class="nv"> </span><span class="s">&#39;&#39;)</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">      </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GreaterThan</span>
<span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;168h&quot;</span><span class="w"> </span><span class="c1"># 7 days</span>
<span class="w">  </span><span class="nt">schedule</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;*/5</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*&quot;</span><span class="w"> </span><span class="c1"># Run check every 5 mins</span>
</code></pre></div>

<p>Example: ClusterCleanupPolicy that will automatically DELETE any Pod that is missing the <code>team</code> label.</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kyverno.io/v2beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterCleanupPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">delete-pods-missing-team-label</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># 1. SCHEDULE</span>
<span class="w">  </span><span class="c1"># Run this check every 5 minutes</span>
<span class="w">  </span><span class="nt">schedule</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;*/5</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*&quot;</span>

<span class="w">  </span><span class="c1"># 2. TARGET RESOURCES</span>
<span class="w">  </span><span class="nt">match</span><span class="p">:</span>
<span class="w">    </span><span class="nt">any</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">        </span><span class="nt">kinds</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="w">        </span><span class="nt">namespaces</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span><span class="w">  </span><span class="c1"># SAFETGUARD: Only delete pods in &#39;default&#39; for now</span>

<span class="w">  </span><span class="c1"># 3. DELETE LOGIC (JMESPath)</span>
<span class="w">  </span><span class="c1"># &quot;If this condition is TRUE, then DELETE the resource.&quot;</span>
<span class="w">  </span><span class="nt">conditions</span><span class="p">:</span>
<span class="w">    </span><span class="nt">all</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">request.object.metadata.labels.team</span><span class="nv"> </span><span class="s">||</span><span class="nv"> </span><span class="s">&#39;&#39;</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">      </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Equals</span>
<span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w">  </span>
<span class="w">      </span><span class="c1"># Logic: If the &#39;team&#39; label is missing (empty), it matches this rule -&gt; DELETE.</span>
</code></pre></div>

<h3>What is failurePolicy?</h3>
<p>This setting defines how Kubernetes should react if the Kyverno controller is DOWN (crashed, timed out, or unreachable).</p>
<p>It determines whether the cluster should "Fail Closed" (Block everything) or "Fail Open" (Let everything pass) during a system outage.</p>
<p>Fail (Default):</p>
<ul>
<li>Behavior: If Kyverno doesn't respond -&gt; BLOCK the API request.</li>
<li>Pro: Maximum Security (nothing bypasses policy).</li>
<li>Con: If Kyverno crashes, your cluster might stop accepting changes (no new Pods).</li>
</ul>
<p>Ignore:</p>
<ul>
<li>Behavior: If Kyverno doesn't respond -&gt; ALLOW the API request.</li>
<li>Pro: High Availability (cluster keeps working even if Kyverno dies).</li>
<li>Con: Security Risk (policies are temporarily skipped).</li>
</ul>
<p>Example:</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kyverno.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical-policy-with-fail-open</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># -------------------------------------------------------------</span>
<span class="w">  </span><span class="c1"># ACTION: If Kyverno is dead, just let the request go through.</span>
<span class="w">  </span><span class="c1"># -------------------------------------------------------------</span>
<span class="w">  </span><span class="nt">failurePolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ignore</span><span class="w"> </span>

<span class="w">  </span><span class="c1"># This is the logic rule (Enforce/Audit)</span>
<span class="w">  </span><span class="nt">validationFailureAction</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Enforce</span>

<span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w"> </span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>

<h3>Relationship between Kyverno and Admission Controller</h3>
<p>Think of Kyverno as a specialized, programmable Admission Controller.</p>
<ul>
<li>Admission Controller: The "Police Station" built into Kubernetes.</li>
<li>Kyverno: A specific "Officer" you hire working at that station, who follows the instructions (Policies) you write in YAML.</li>
</ul>
<p>You use Kyverno TO implement Admission Control. Instead of writing a custom Go webhook server to validate your labels, you just apply a Kyverno YAML.</p>
<h3>Kyverno CLI</h3>
<ul>
<li>Checks if resources pass or fail a policy.</li>
</ul>
<div class="highlight"><pre><span></span><code>kyverno<span class="w"> </span>apply<span class="w"> </span>policy.yaml<span class="w"> </span>--resource<span class="w"> </span>pod.yaml
</code></pre></div>

<ul>
<li>Runs structured tests defined in a <code>kyverno-test.yaml</code> file.</li>
</ul>
<div class="highlight"><pre><span></span><code>kyverno<span class="w"> </span><span class="nb">test</span><span class="w"> </span>./tests
</code></pre></div>

<ul>
<li>Tests a specific JMESPath expression against JSON input.</li>
</ul>
<div class="highlight"><pre><span></span><code>kyverno<span class="w"> </span>jp<span class="w"> </span>query<span class="w"> </span>-i<span class="w"> </span>object.json<span class="w"> </span><span class="s1">&#39;metadata.labels&#39;</span>
</code></pre></div>

<ul>
<li>Checks if your policy YAML is written correctly.</li>
</ul>
<div class="highlight"><pre><span></span><code>kyverno<span class="w"> </span>validate<span class="w"> </span>policy.yaml
</code></pre></div>

<ul>
<li>Shows the installed CLI version.</li>
</ul>
<div class="highlight"><pre><span></span><code>kyverno<span class="w"> </span>version
</code></pre></div>

<h3>What is External Data Source?</h3>
<p>Purpose: It allows you to load data from outside into a variable before the rule logic (validate/mutate) runs.</p>
<p>Document: https://main.kyverno.io/docs/policy-types/cluster-policy/external-data-sources/</p>
<div class="highlight"><pre><span></span><code><span class="nv">In</span><span class="w"> </span><span class="nv">order</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">consume</span><span class="w"> </span><span class="nv">data</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">ConfigMap</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">rule</span>,<span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">context</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">required</span>...<span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">context</span><span class="w"> </span><span class="nv">data</span><span class="w"> </span><span class="nv">can</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="nv">be</span><span class="w"> </span><span class="nv">referenced</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">policy</span><span class="w"> </span><span class="nv">rule</span><span class="w"> </span><span class="nv">using</span><span class="w"> </span><span class="nv">JMESPath</span><span class="w"> </span><span class="nv">notation</span>.
</code></pre></div>

<p>Kyverno supports 3 main data sources in <code>context</code>:</p>
<ul>
<li>Kubernetes Resources (via API Call): Look up existing data in the cluster (e.g., ConfigMaps, Secrets, Services).</li>
<li>External APIs: Make an HTTP call to a service outside the cluster.</li>
<li>Image Registry: Fetch metadata about a container image (e.g., image size, architecture).</li>
</ul>
<p>Scenario: You want to enforce a rule that "Pods can only use roles defined in a shared ConfigMap".</p>
<div class="highlight"><pre><span></span><code><span class="n">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span><span class="w"> </span><span class="n">ConfigMap</span>
<span class="n">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">allowed</span><span class="o">-</span><span class="n">roles</span><span class="o">-</span><span class="n">cm</span>
<span class="w">  </span><span class="n">namespace</span><span class="p">:</span><span class="w"> </span><span class="n">default</span>
<span class="n">data</span><span class="p">:</span>
<span class="w">  </span><span class="n">roles</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;[&quot;frontend&quot;, &quot;backend&quot;, &quot;cache&quot;]&#39;</span>
<span class="o">---</span>
<span class="n">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="n">kyverno</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span><span class="w"> </span><span class="n">ClusterPolicy</span>
<span class="n">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">validate</span><span class="o">-</span><span class="n">role</span><span class="o">-</span><span class="n">from</span><span class="o">-</span><span class="n">configmap</span>
<span class="n">spec</span><span class="p">:</span>
<span class="w">  </span><span class="n">validationFailureAction</span><span class="p">:</span><span class="w"> </span><span class="n">Enforce</span>
<span class="w">  </span><span class="n">rules</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">check</span><span class="o">-</span><span class="n">role</span>
<span class="w">      </span><span class="k">match</span><span class="p">:</span>
<span class="w">        </span><span class="n">any</span><span class="p">:</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">resources</span><span class="p">:</span>
<span class="w">            </span><span class="n">kinds</span><span class="p">:</span>
<span class="w">              </span><span class="o">-</span><span class="w"> </span><span class="n">Pod</span>
<span class="w">      </span><span class="c1"># ---------------------------------------------------------</span>
<span class="w">      </span><span class="c1"># CONTEXT: Load data from ConfigMap into variable &quot;allowed_list&quot;</span>
<span class="w">      </span><span class="c1"># ---------------------------------------------------------</span>
<span class="w">      </span><span class="n">context</span><span class="p">:</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">allowed_list</span>
<span class="w">          </span><span class="n">apiCall</span><span class="p">:</span>
<span class="w">            </span><span class="c1"># We call the K8s API to fetch the ConfigMap</span>
<span class="w">            </span><span class="n">urlPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/api/v1/namespaces/default/configmaps/allowed-roles-cm&quot;</span>
<span class="w">            </span><span class="n">jmesPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;data.roles&quot;</span><span class="w"> </span><span class="c1"># Extract just the roles list</span>
<span class="w">      </span><span class="n">validate</span><span class="p">:</span>
<span class="w">        </span><span class="n">message</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Invalid Role! It must be in the allowed list.&quot;</span>
<span class="w">        </span><span class="c1"># Use the variable {{ allowed_list }} we just loaded</span>
<span class="w">        </span><span class="n">deny</span><span class="p">:</span>
<span class="w">          </span><span class="n">conditions</span><span class="p">:</span>
<span class="w">            </span><span class="n">all</span><span class="p">:</span>
<span class="w">            </span><span class="o">-</span><span class="w"> </span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{{ request.object.metadata.labels.role }}&quot;</span>
<span class="w">              </span><span class="n">operator</span><span class="p">:</span><span class="w"> </span><span class="n">AnyNotIn</span>
<span class="w">              </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{{ allowed_list }}&quot;</span>
</code></pre></div>

<ul>
<li>We apply manifest:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">database-pod</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># This is the label being checked by the policy</span>
<span class="w">    </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">database</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db-container</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:15</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5432</span>
</code></pre></div>

<ul>
<li>Kyverno Logic: Checks <code>metadata.labels.role</code> ("database").</li>
<li>Comparison: "database" is NOT in the allowed list <code>["frontend", "backend", "cache"]</code></li>
<li>Result:</li>
</ul>
<div class="highlight"><pre><span></span><code>Error from server: error when creating &quot;pod-request.yaml&quot;: admission webhook &quot;validate.kyverno.svc-fail&quot; denied the request:

validate-role-from-configmap:
  check-role: Role is not allowed!
</code></pre></div>

<h3>Extra example for API Call in external data source</h3>
<div class="highlight"><pre><span></span><code><span class="nt">context</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">podCount</span>
<span class="w">    </span><span class="nt">apiCall</span><span class="p">:</span><span class="w">       </span><span class="c1"># &lt;--- Generic field for ANY Kubernetes resource</span>
<span class="w">      </span><span class="nt">urlPath</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/api/v1/namespaces/{{request.namespace}}/pods&quot;</span>
<span class="w">      </span><span class="nt">jmesPath</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;items</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">length(@)&quot;</span>
</code></pre></div>

<h3>Default Port in Kyverno</h3>
<p>Here is the list of default ports used by Kyverno:</p>
<p>Webhook Server Port 9443 (HTTPS/TCP):</p>
<ul>
<li><strong>Purpose:</strong> This is the secure port where the Kubernetes API Server sends Admission Requests to Kyverno.</li>
<li><strong>Usage:</strong> It handles policy validation and mutation logic.</li>
</ul>
<p>Metrics Port 8000 (HTTP/TCP):</p>
<ul>
<li><strong>Purpose:</strong> Exposes Prometheus metrics.</li>
<li><strong>Usage:</strong> Scraped by Prometheus at <code>/metrics</code> to monitor policy execution counts, latency, and rule results.</li>
</ul>
<p>Probes / Health Check Port 8080 (HTTP/TCP): </p>
<ul>
<li><strong>Purpose:</strong> Used for Liveness and Readiness probes.</li>
<li><strong>Usage:</strong> The Kubelet checks <code>/health/liveness</code> and <code>/health/readiness</code> on this port to ensure the Pod is healthy.</li>
</ul>
<p>Pprof (Profiler) Port 6060 (HTTP/TCP): (Optional):</p>
<ul>
<li><strong>Purpose:</strong> Used for debugging and profiling Go performance.</li>
<li><strong>Usage:</strong> Disabled by default. Only open if you specifically enable profiling flags for debugging.</li>
</ul>
<p><strong>Summary:</strong> The most critical port is <strong>9443</strong>, as that is the main communication line between Kubernetes and Kyverno.</p>
<h3>Kyverno Mutate - JSON Patch</h3>
<p><strong>patchesJson6902</strong> is a mutation method used when you need <strong>surgical precision</strong> to modify a resource.</p>
<p>Unlike the standard <code>patchStrategicMerge</code> (which merges YAMLs together), this uses <strong>specific operations</strong> (RFC 6902 standard) to tell Kyverno exactly <em>how</em> to change the data.</p>
<p>When to use it?</p>
<p>Use it when <code>patchStrategicMerge</code> cannot do the job, specifically for:</p>
<ul>
<li><strong>Removing</strong> a field (impossible with standard merge).</li>
<li><strong>Adding</strong> an item to a specific position in a list (arrays).</li>
<li><strong>Replacing</strong> a value entirely without merging.</li>
</ul>
<p>It follows the JSON Patch format:</p>
<ul>
<li><strong>op</strong>: The action (<code>add</code>, <code>remove</code>, <code>replace</code>).</li>
<li><strong>path</strong>: The location of the field (e.g., <code>/metadata/labels/mytag</code>).</li>
<li><strong>value</strong>: The data to put there.</li>
</ul>
<p>Example: "Add a sidecar container"</p>
<p>This adds a new container to the <strong>start</strong> of the <code>containers</code> list (index 0).</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kyverno.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">add-sidecar</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">inject-sidecar</span>
<span class="w">    </span><span class="nt">match</span><span class="p">:</span>
<span class="w">      </span><span class="nt">any</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">          </span><span class="nt">kinds</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="w">    </span><span class="nt">mutate</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># Note the |- block scalar, this expects a JSON/YAML list string</span>
<span class="w">      </span><span class="nt">patchesJson6902</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
<span class="w">        </span><span class="no">- op: add</span>
<span class="w">          </span><span class="no">path: /spec/containers/0</span>
<span class="w">          </span><span class="no">value:</span>
<span class="w">            </span><span class="no">name: my-sidecar</span>
<span class="w">            </span><span class="no">image: alpine:latest</span>
</code></pre></div>

<ul>
<li><strong>Official Docs:</strong> <a href="https://main.kyverno.io/docs/policy-types/cluster-policy/mutate/#rfc-6902-jsonpatch">Kyverno Mutate - JSON Patch</a></li>
</ul>
<hr>
<h1>More for JMESPath which will appear a lot in exam xD</h1>
<h3>Filtering (Critical)</h3>
<p>The exam often asks: "Block the Pod if ANY container uses an image with the 'latest' tag" or "Find containers that do not have memory limits set".</p>
<p>You must use the <code>[?expression]</code> syntax.</p>
<p>Syntax: <code>request.object.spec.containers[? filter_condition ]</code></p>
<p>Example: Find all containers where the image starts with "nginx":</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Returns a list of container objects that match the condition</span>
<span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">request.object.spec.containers</span><span class="p p-Indicator">[?</span><span class="nv">starts_with(image</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;nginx&#39;</span><span class="nv">)</span><span class="p p-Indicator">]</span><span class="w"> </span><span class="p p-Indicator">}}</span>
</code></pre></div>

<p>Kyverno Application (Deny if found):</p>
<div class="highlight"><pre><span></span><code><span class="nt">validate</span><span class="p">:</span>
<span class="w">  </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Nginx</span><span class="nv"> </span><span class="s">images</span><span class="nv"> </span><span class="s">are</span><span class="nv"> </span><span class="s">not</span><span class="nv"> </span><span class="s">allowed!&quot;</span>
<span class="w">  </span><span class="nt">deny</span><span class="p">:</span>
<span class="w">    </span><span class="nt">conditions</span><span class="p">:</span>
<span class="w">      </span><span class="nt">all</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># Filter the list. Use length() to count. </span>
<span class="w">      </span><span class="c1"># If count &gt; 0, it means a violation exists -&gt; Block.</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">request.object.spec.containers[?starts_with(image,</span><span class="nv"> </span><span class="s">&#39;nginx&#39;)]</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">length(@)</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">        </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GreaterThan</span>
<span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</code></pre></div>

<h3>Pipe Operator | (Projection)</h3>
<p>Used to extract a specific field from a complex object into a flat list.</p>
<p>Example: You don't want the whole container object; you just want a list of image names.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Input: List of container objects</span>
<span class="c1"># Output: [&quot;nginx:latest&quot;, &quot;redis:alpine&quot;, &quot;busybox&quot;]</span>
<span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">request.object.spec.containers[].image</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div>

<p>Exam Combo (Filter + Pipe): "Get the containerPort of the container named 'app'" <code>request.object.spec.containers[?name == 'app'].ports[].containerPort</code></p>
<h3>Null Handling (The Exam Trap)</h3>
<p>This is where many people fail. If a field does not exist in the YAML, JMESPath returns null, causing the Policy to crash or behave unexpectedly.</p>
<p>Use the || (OR) operator to set a default value.</p>
<p>Example: Check the team label. What if the Pod has no labels at all?</p>
<ul>
<li>Risk: <code>{{ request.object.metadata.labels.team }}</code> (If null -&gt; Error).</li>
<li>Safe: <code>{{ request.object.metadata.labels.team || '' }}</code> (If null -&gt; treat as empty string).</li>
</ul>
<p>Kyverno Application:</p>
<div class="highlight"><pre><span></span><code><span class="nt">preconditions</span><span class="p">:</span>
<span class="w">  </span><span class="nt">all</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">request.object.metadata.labels.team</span><span class="nv"> </span><span class="s">||</span><span class="nv"> </span><span class="s">&#39;no-team&#39;</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">    </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Equals</span>
<span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;production&quot;</span>
</code></pre></div>

<h3>The length() function</h3>
<p>Used to limit the quantity of a resource.</p>
<p>Example: "A Pod must not have more than 3 containers."</p>
<div class="highlight"><pre><span></span><code><span class="nt">validate</span><span class="p">:</span>
<span class="w">  </span><span class="nt">deny</span><span class="p">:</span>
<span class="w">    </span><span class="nt">conditions</span><span class="p">:</span>
<span class="w">      </span><span class="nt">all</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">request.object.spec.containers</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">length(@)</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">        </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GreaterThan</span>
<span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</code></pre></div>

<h3>Sample JMESPath question #1</h3>
<p>Scenario: You are writing a policy against the following Pod JSON. Analyze this JSON and answer the 3 questions below.</p>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">{</span>
<span class="w">  </span><span class="s">&quot;apiVersion&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;v1&quot;</span><span class="p p-Indicator">,</span>
<span class="w">  </span><span class="s">&quot;kind&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;Pod&quot;</span><span class="p p-Indicator">,</span>
<span class="w">  </span><span class="s">&quot;metadata&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span>
<span class="w">    </span><span class="s">&quot;name&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;backend-app&quot;</span><span class="p p-Indicator">,</span>
<span class="w">    </span><span class="s">&quot;labels&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span>
<span class="w">      </span><span class="s">&quot;app&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;backend&quot;</span><span class="p p-Indicator">,</span>
<span class="w">      </span><span class="s">&quot;env&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;production&quot;</span>
<span class="w">    </span><span class="p p-Indicator">}</span>
<span class="w">  </span><span class="p p-Indicator">},</span>
<span class="w">  </span><span class="s">&quot;spec&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span>
<span class="w">    </span><span class="s">&quot;containers&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[</span>
<span class="w">      </span><span class="p p-Indicator">{</span>
<span class="w">        </span><span class="s">&quot;name&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;main-app&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;image&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;my-org/app:v1&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;ports&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[</span>
<span class="w">          </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="s">&quot;containerPort&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">8080</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;protocol&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;TCP&quot;</span><span class="w"> </span><span class="p p-Indicator">}</span>
<span class="w">        </span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="p p-Indicator">},</span>
<span class="w">      </span><span class="p p-Indicator">{</span>
<span class="w">        </span><span class="s">&quot;name&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;sidecar-logger&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;image&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;fluentd:latest&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;ports&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="w">      </span><span class="p p-Indicator">}</span>
<span class="w">    </span><span class="p p-Indicator">],</span>
<span class="w">    </span><span class="s">&quot;volumes&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[</span>
<span class="w">      </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="s">&quot;name&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;config&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;configMap&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="s">&quot;name&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;app-conf&quot;</span><span class="w"> </span><span class="p p-Indicator">}</span><span class="w"> </span><span class="p p-Indicator">},</span>
<span class="w">      </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="s">&quot;name&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;data&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;emptyDir&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{}</span><span class="w"> </span><span class="p p-Indicator">}</span>
<span class="w">    </span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="p p-Indicator">}</span>
<span class="p p-Indicator">}</span>
</code></pre></div>

<p>Question Basic Selection: You need to extract the name of the first container in the list</p>
<ul>
<li>Answer:</li>
</ul>
<div class="highlight"><pre><span></span><code>spec.containers[0].name
</code></pre></div>

<ul>
<li>Explanation: In JMESPath, you access array items by index using brackets [0].</li>
</ul>
<p>Question Filtering &amp; Counting: You want to check how many containers are using the latest tag. Which JMESPath expression returns the <code>count (integer)</code>?</p>
<ul>
<li>Answer:</li>
</ul>
<div class="highlight"><pre><span></span><code>spec.containers[?contains(image, &#39;latest&#39;)] | length(@)
</code></pre></div>

<ul>
<li>Explanation:</li>
</ul>
<div class="highlight"><pre><span></span><code>- spec.containers[...]: Access the list
- [?contains(image, &#39;latest&#39;)]: Filter the list to keep only objects where the image string contains &quot;latest&quot;.
- | length(@): Pipe the result to the length function to count them.
</code></pre></div>

<p>Complex Projection: You want to find the names of all volumes that are of type <code>emptyDir</code>. Which expression returns <code>["data"]</code>?</p>
<ul>
<li>Answer: </li>
</ul>
<div class="highlight"><pre><span></span><code>spec.volumes[?emptyDir != null].name
</code></pre></div>

<ul>
<li>Explanation:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">We</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="kr">to</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="n">emptyDir</span><span class="w"> </span><span class="n">exists</span><span class="mf">.</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">In</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="n">volume</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;config&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">emptyDir</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">missing</span><span class="w"> </span><span class="p">(</span><span class="n">null</span><span class="p">)</span><span class="mf">.</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">In</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">second</span><span class="w"> </span><span class="n">volume</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">emptyDir</span><span class="w"> </span><span class="n">exists</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="err">{}</span><span class="p">)</span><span class="mf">.</span>
<span class="mf">4.</span><span class="w"> </span><span class="err">[?</span><span class="n">emptyDir</span><span class="w"> </span><span class="err">!</span><span class="o">=</span><span class="w"> </span><span class="n">null</span><span class="err">]</span><span class="w"> </span><span class="n">filters</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="kr">list</span><span class="w"> </span><span class="kr">to</span><span class="w"> </span><span class="n">keep</span><span class="w"> </span><span class="kr">on</span><span class="n">ly</span><span class="w"> </span><span class="n">volumes</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">field</span><span class="mf">.</span>
<span class="mf">5.</span><span class="w"> </span><span class="mf">.</span><span class="n">name</span><span class="w"> </span><span class="n">extracts</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="c1">remaining items.</span>
<span class="mf">6.</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">JMESPath</span><span class="w"> </span><span class="n">implementations</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="err">[?</span><span class="n">emptyDir</span><span class="err">]</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">shorthand</span><span class="w"> </span><span class="kr">for</span><span class="w"> </span><span class="s">&quot;not null&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="err">!</span><span class="o">=</span><span class="w"> </span><span class="n">null</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">strict</span><span class="w"> </span><span class="n">standard</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">many</span><span class="w"> </span><span class="n">exams</span><span class="mf">.</span>
</code></pre></div>


             
 
            
            
            







            <hr/>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2025-12-18T00:00:00+07:00">Thu 18 December 2025</time>
            <h4>Category</h4>
            <a class="category-link" href="/categories.html#knowledge-base-ref">Knowledge Base</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="/tags.html#certification-ref">certification
                    <span class="superscript">6</span>
</a></li>
                <li><a href="/tags.html#kca-ref">kca
                    <span class="superscript">1</span>
</a></li>
                <li><a href="/tags.html#kyverno-ref">kyverno
                    <span class="superscript">1</span>
</a></li>
                <li><a href="/tags.html#linux-foundation-ref">linux-foundation
                    <span class="superscript">6</span>
</a></li>
            </ul>
<h4>Contact</h4>
<div id="sidebar-social-link">
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="/theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>