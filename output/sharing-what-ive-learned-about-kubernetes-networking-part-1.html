<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="/theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="author" content="kienlt" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="k8s, Knowledge Base, " />

<meta property="og:title" content="Sharing What I&#39;ve Learned About Kubernetes Networking - Part 1 "/>
<meta property="og:url" content="/sharing-what-ive-learned-about-kubernetes-networking-part-1.html" />
<meta property="og:description" content="" />
<meta property="og:site_name" content="Kienlt&#39;s notebook" />
<meta property="og:article:author" content="kienlt" />
<meta property="og:article:published_time" content="2025-01-17T00:00:00+07:00" />
<meta name="twitter:title" content="Sharing What I&#39;ve Learned About Kubernetes Networking - Part 1 ">
<meta name="twitter:description" content="">

        <title>Sharing What I&#39;ve Learned About Kubernetes Networking - Part 1  · Kienlt&#39;s notebook
</title>



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="/"><span class=site-name>Kienlt's notebook</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       "/"
                                    >Home</a>
                                </li>
                                <li ><a href="/categories.html">Categories</a></li>
                                <li ><a href="/tags.html">Tags</a></li>
                                <li ><a href="/archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="/sharing-what-ive-learned-about-kubernetes-networking-part-1.html">
                Sharing What I've Learned About Kubernetes Networking - Part 1
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <p>In the first part, I will talk about Kubernetes Service, Ingress, and Service Discovery</p>
<h1>Kubernetes Services!</h1>
<p>In Kubernetes, a Service is a method for exposing a network application that is running as one or more Pods in your cluster.
So how many types of Services? There are 4 types:</p>
<p><img alt="2025-01-17" src="images/2025/01/17th_1.png"></p>
<h3>Service type, there are 4 types of service:</h3>
<ol>
<li>
<p><strong>ClusterIP</strong>: Exposes the Service on a cluster-internal IP. Choosing this value makes the Service only reachable from within the cluster. This is the default ServiceType ( if you don't define the type, it will be ClusterIP)</p>
</li>
<li>
<p><strong>NodePort</strong>: Exposes the Service on each Node’s IP at a static port (the NodePort). A ClusterIP Service, to which the NodePort Service routes, is automatically created. You’ll be able to contact the NodePort Service, from outside the cluster, by requesting <code>&lt;NodeIP&gt;:&lt;NodePort&gt;</code>. Default port range: <code>30000-32767</code></p>
</li>
<li>
<p><strong>LoadBalancer</strong>: Exposes the Service externally using a cloud provider’s load balancer. NodePort and ClusterIP Services, to which the external load balancer routes, are automatically created.</p>
<ul>
<li>If you're running Kubernetes on a cloud provider that supports load balancer services (like AWS, GCP, Azure), then type: LoadBalancer will work as expected.</li>
<li>If you're running Kubernetes on-premises or on a cloud provider that doesn't support load balancers, type: LoadBalancer will not work.</li>
</ul>
</li>
<li>
<p><strong>ExternalName</strong>: Maps the Service to the contents of the externalName field (e.g. <code>my.database.example.com</code>), by returning a CNAME record with its value.</p>
</li>
</ol>
<h3>Let's dive deep into each section with the use case and example with the manifest so you can imagine it easily!</h3>
<h4>1. <strong>ClusterIP</strong>:</h4>
<p>I assume you have Redis pod already and you want to access it from the backend server, The backend server is in the same k8s cluster.</p>
<ul>
<li>Manifest demo: </li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis-test-clusterip</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis-standalone</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIP</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">6379</span>
<span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">6379</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis-test</span>
</code></pre></div>

<ul>
<li>Access it with FQDN: <code>redis-test-clusterip.redis-standalone.svc.cluster.local:6379</code></li>
<li>Explains: Fully qualified domain name (FQDN) of the Service. The FQDN takes the form <code>service-name.namespace.svc.cluster.local</code>, where:<ul>
<li><code>service-name</code> is the name of the Service.</li>
<li><code>namespace-name</code> is the namespace in which the Service resides.</li>
<li><code>svc</code> is a static value.</li>
<li><code>cluster.local</code> is the default domain for the cluster. This can be customized during cluster setup.</li>
</ul>
</li>
<li>The DNS service in Kubernetes (like CoreDNS or kube-dns) is responsible for resolving this FQDN to the appropriate Service. When you create a Service, Kubernetes automatically creates a corresponding DNS record. This allows Pods in the cluster to access the Service using the FQDN.</li>
</ul>
<h4>2. <strong>NodePort</strong>:</h4>
<p>From my experience, this is the most i used when i began with k8s service expose ( that's a time i had no idea about ingress xD), so how i used it.<br></p>
<p>Service can be accessed from any node directly with <code>&lt;node-ip&gt;:&lt;port&gt;</code>. This is mostly used for quick access without running port-forward or any other action and ofc you have to allow access port from the server to your IP address, i mean the firewall!</p>
<ul>
<li>For adding backend to Haproxy <br></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">backend http_backend-name-here</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">mode    http</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">option forwardfor header X-Client-RIP</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">balance roundrobin</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">server 10.0.0.1:32332 10.0.0.1:32332 check inter 4000 rise 2 fall 10</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">server 10.0.0.2:32332 10.0.0.2:32332 check inter 4000 rise 2 fall 10</span>
</code></pre></div>

<ul>
<li>Used it as a target for Upstream in Kong - API Gateway <br>
<img alt="alt text" src="images/2025/01/17th_2.png"></li>
</ul>
<h4>3. LoadBalancer:</h4>
<p>At this time, i don't use K8s in the cloud yet. I will update you when i finish my lab with EKS/GKE later.</p>
<h4>4. ExternalName</h4>
<p>When i learned this for the first time or second time, i didn't really know why it gonna being used, but after several times i got this.</p>
<ul>
<li>
<p>For consistency, when you change the domain of an external name, it takes only 5–10 seconds to update in the container without restarting. You don't have to restart the container to take the changes, if you mount config from ConfigMap or Secret, you will have to restart pod xD.</p>
</li>
<li>
<p>Leverages K8S internal DNS resolution, you don't need any external DNS server. K8S acts as a DNS Server at this point xD.</p>
</li>
<li>
<p>Better integration with k8s network policies and service management. I think you will not understand this sentence like me xD. So i asked Copilot to explain.</p>
<ul>
<li>
<p>Network Policies: Kubernetes network policies allow you to control the communication between Pods and Services within the cluster. However, ExternalName Services do not directly interact with Pods; they map to external DNS names. This means that network policies within the cluster do not apply to the external services directly. Instead, you need to manage network policies at the cluster boundary or use other mechanisms to secure communication with external services.</p>
</li>
<li>
<p>Service Management: Kubernetes provides robust service management features, such as service discovery, load balancing, and DNS resolution. ExternalName Services leverage Kubernetes' DNS resolution capabilities to provide a seamless way to access external services using a consistent internal DNS name. This allows for better integration and management of external services within the Kubernetes ecosystem, as you can reference external services using Kubernetes Service names.</p>
</li>
</ul>
</li>
<li>
<p>Centralizes the configuration of external dependencies within K8S.</p>
</li>
<li>
<p>Example manifest:</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-external-service</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sysadmin</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ExternalName</span>
<span class="w">  </span><span class="nt">externalName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my.database.example.com</span>
</code></pre></div>

<h1>Ingress!</h1>
<p>Mostly i will talk only about Nginx ingress!</p>
<h4>Quick start</h4>
<p>It will be a little hard to summarize ingress in some words, but i will try my best to explain.</p>
<p>Kubernetes Ingress is a resource that allows you to manage external access to your services, typically HTTP ( It does support TLS/SSL). It acts as a reverse proxy, routing traffic from a DNS name to the appropriate services within your cluster.</p>
<ul>
<li><strong>DNS</strong>: Points to the Ingress controller (proxy server).</li>
<li>
<p><strong>Ingress Controller</strong>: Forwards traffic to the configured services based on rules defined in the Ingress resource.</p>
</li>
<li>
<p>Example manifest and haproxy stand before Ingress:</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example-ingress</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example.com</span>
<span class="w">    </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example-service</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div>

<p>Haproxy config</p>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">backend http_example.com</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">mode    http</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">option forwardfor header X-Client-RIP</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">balance roundrobin</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">server 10.0.0.1:80 10.0.0.1:80 check inter 1000 rise 2 fall 10</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">server 10.0.0.2:80 10.0.0.2:80 check inter 1000 rise 2 fall 10</span>
</code></pre></div>

<p><strong>Explain</strong>: DNS will point the domain to the Haproxy server. Haproxy will forward traffic to the Ingress Controller ( 10.0.0.1 and 10.0.0.2 are Ingress Controller). Why do i know port 80 is being used?
Because i installed nginx ingress as Daemonset, in default it used hostPort in the ports section of Daemonset</p>
<div class="highlight"><pre><span></span><code><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rke2-ingress-nginx-controller</span>
<span class="nt">ports</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">  </span><span class="nt">hostPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<span class="w">  </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
<span class="w">  </span><span class="nt">hostPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https</span>
<span class="w">  </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8443</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">webhook</span>
<span class="w">  </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
</code></pre></div>

<p>And why do i use 80 not 443?, for not double encrypt, because in Haproxy it redirected requests to HTTPS, so extra SSL is not necessary and may <strong>increase extra CPU load</strong>.</p>
<h4>Ingress workflows:</h4>
<ul>
<li>Ingress has routing rules to service</li>
<li>Ingress flows:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="n">Request</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="n">sends</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">api</span><span class="o">.</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">Ingress</span><span class="w"> </span><span class="n">Controller</span><span class="p">:</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Ingress</span><span class="w"> </span><span class="n">Controller</span><span class="o">.</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">Ingress</span><span class="w"> </span><span class="n">Resource</span><span class="p">:</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">Ingress</span><span class="w"> </span><span class="n">Controller</span><span class="w"> </span><span class="n">looks</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Ingress</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">routing</span><span class="w"> </span><span class="n">rules</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">api</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">determines</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">corresponding</span><span class="w"> </span><span class="n">Service</span><span class="o">.</span>
<span class="mf">4.</span><span class="w"> </span><span class="n">Service</span><span class="p">:</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">forwarded</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="n">named</span><span class="w"> </span><span class="n">my</span><span class="o">-</span><span class="n">service</span><span class="o">.</span>
<span class="mf">5.</span><span class="w"> </span><span class="n">Endpoint</span><span class="p">:</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="n">finds</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">endpoints</span><span class="w"> </span><span class="p">(</span><span class="n">IP</span><span class="w"> </span><span class="n">addresses</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Pods</span><span class="p">)</span><span class="w"> </span><span class="n">associated</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">selects</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">based</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="nb">load</span><span class="w"> </span><span class="n">balancing</span><span class="w"> </span><span class="n">policy</span><span class="o">.</span>
<span class="mf">6.</span><span class="w"> </span><span class="n">Pod</span><span class="p">:</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">routed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">selected</span><span class="w"> </span><span class="n">Pod</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">application</span><span class="o">.</span>
</code></pre></div>

<h4>Some common error scenarios of nginx ingress</h4>
<p><strong>1. Missing annotation rewrite-target</strong> </br>
- I'm assuming the ingress controller and backend service still running. This will return 404 errors. </br></p>
<ul>
<li>
<p>Specifically, the Ingress rule is set to match requests to the path /test, but without the rewrite-target annotation, the request path is not modified before being sent to the backend service.</br></p>
</li>
<li>
<p>Why it will return a 404 error?:</br></p>
<ul>
<li>Request Path Mismatch: The Ingress rule matches requests to example.com/test and forwards them to the backend-service on port 80. </br></li>
<li>Backend Service Path Handling: The backend service expects requests to be at the root path /, but the Ingress controller forwards the request with the original path /test </br></li>
<li>404 Not Found: Since the backend service does not have a handler for the /test path, it returns a 404 Not Found error. </br></li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># misconfiguration</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example-ingress</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test1</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example.com</span>
<span class="w">    </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/test</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backend-service</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># Correct configuration with the rewrite-target annotation</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example-ingress</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test1</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/rewrite-target</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example.com</span>
<span class="w">    </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/test</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backend-service</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div>

<p><strong>2. Other issues related to 404</strong> </p>
<ul>
<li>
<p>Incorrect Path Configuration: If the pathType is set to Exact but the request path does not match exactly, it will return a 404. For example, if the path is /test and the request is for /test/, it will not match. Note that using the Prefix pathType allows /test to match /test/ and its sub-paths, which may avoid this issue.</p>
</li>
<li>
<p>Service Name Mismatch: If the service name specified in the Ingress does not match any existing service, the Ingress will not be able to route the traffic correctly, resulting in a 404 error.</p>
</li>
<li>
<p>Namespace Mismatch: If the Ingress resource is in a different namespace than the service it is trying to route to, it will not find the service and return a 404.</p>
</li>
<li>
<p>Ingress Controller Not Running: If the NGINX Ingress Controller itself is not running or not properly configured, traffic will not be routed. This might result in a 404 error if another Ingress Controller handles the traffic and does not recognize the configuration. Otherwise, the traffic may fail to reach the cluster altogether.</p>
</li>
<li>
<p>DNS Issues: If the DNS is not properly configured to point to the Ingress Controller, the requests will not reach the Ingress. This would typically result in a DNS resolution error, not a 404. A 404 might occur only if DNS resolves to the Ingress Controller but the Ingress rules are not properly configured.</p>
</li>
</ul>
<p><strong>3. Other possible errors 400,502,503...</strong></p>
<p>It will be way too long to include, but pretty useful in case you have to debug: 
<a href="https://gist.github.com/BlackMetalz/dab403875c8433a800c7b61a57df2a3e">Github Gist</a></p>
<h1>Service Discovery and DNS</h1>
<p>Here's a concise and clear explanation of <strong>Service Discovery in Kubernetes</strong>:</p>
<ol>
<li>
<p><strong>Services and Endpoints</strong>:</p>
<ul>
<li>
<p>A <strong>Service</strong> in Kubernetes provides a stable IP and DNS name to access a group of Pods (e.g., from a Deployment).</p>
</li>
<li>
<p>When a Service is created, Kubernetes automatically creates an <strong>Endpoint</strong> object that maps the Service to the IPs of its associated Pods.</p>
</li>
<li>
<p>If your Deployment has 2 Pods, the Endpoint will list 2 IPs of the pod. This updates dynamically when Pods are added, removed, or replaced.</p>
</li>
<li>
<p>K8S restricts endpoints to 1000.</p>
</li>
</ul>
</li>
<li>
<p><strong>DNS-based Discovery</strong>:</p>
<ul>
<li>
<p>Kubernetes automatically sets up a <strong>DNS name</strong> for each Service. For example, a Service named <code>my-service</code> in the <code>default</code> namespace will be available at <code>my-service.default.svc.cluster.local</code>.</p>
</li>
<li>
<p>Any Pod in the cluster can use this DNS name to connect to the Service, regardless of where the Pods are running.</p>
</li>
</ul>
</li>
<li>
<p><strong>Environment Variables</strong>:</p>
<ul>
<li>
<p>When a Pod is started, Kubernetes injects <strong>environment variables</strong> into the container with information about Services in the same namespace.</p>
</li>
<li>
<p>All Services in the same namespace that exists before the Pod starts will have their information injected into the Pod's environment variables. These environment variables will include:
<code>&lt;SERVICE_NAME&gt;_SERVICE_HOST: The Service's cluster IP.
&lt;SERVICE_NAME&gt;_SERVICE_PORT: The Service's port.</code></p>
</li>
<li>
<p>You can check by getting all services and running the command <code>env</code> in a container.</p>
</li>
</ul>
</li>
</ol>
<div class="highlight"><pre><span></span><code>ERROR_499_PORT_80_TCP_PORT=80
ERROR_499_PORT_80_TCP_PROTO=tcp
ERROR_500_SERVICE_HOST=10.43.227.32
ERROR_502_SERVICE_HOST=10.43.64.240
ERROR_503_SERVICE_HOST=10.43.196.86
ERROR_499_PORT_80_TCP=tcp://10.43.116.35:80
ERROR_504_SERVICE_HOST=10.43.6.79
ERROR_500_PORT=tcp://10.43.227.32:80
ERROR_500_SERVICE_PORT=80
ERROR_502_PORT=tcp://10.43.64.240:80
ERROR_502_SERVICE_PORT=80
ERROR_503_PORT=tcp://10.43.196.86:80
ERROR_503_SERVICE_PORT=80
ERROR_504_PORT=tcp://10.43.6.79:80
</code></pre></div>

<ul>
<li>With the following services.</li>
</ul>
<div class="highlight"><pre><span></span><code># kubectl get svc
NAME                  TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)                         AGE
error-499             ClusterIP      10.43.116.35    &lt;none&gt;          80/TCP                          2d21h
error-500             ClusterIP      10.43.227.32    &lt;none&gt;          80/TCP                          2d21h
error-502             ClusterIP      10.43.64.240    &lt;none&gt;          80/TCP                          2d21h
error-503             ClusterIP      10.43.196.86    &lt;none&gt;          80/TCP                          2d21h
error-504             ClusterIP      10.43.6.79      &lt;none&gt;          80/TCP                          2d21h
</code></pre></div>

<h4>Summary:</br></h4>
<ul>
<li><strong>Endpoint</strong> links Services to Pod IPs and dynamically updates with Pod changes.</br></li>
<li>Pods can discover Services using <strong>DNS names</strong> or <strong>environment variables</strong>.</br></li>
<li>Kubernetes automatically handles traffic routing and load balancing for Services.</br>
This ensures seamless communication and discovery between applications running in your cluster!</li>
</ul>
<h4>How DNS Resolv addresses</h4>
<p>how DNS resolution works in Kubernetes based on <code>resolv.conf</code> the behavior for resolving <code>my-app</code>:</p>
<p><strong>Key Points:</strong></p>
<ol>
<li>
<p><strong><code>/etc/resolv.conf</code></strong>:</p>
<ul>
<li>The <code>search</code> line specifies the DNS search domains that will be appended to any domain you try to resolve (if it doesn't have enough dots to be considered fully qualified).</li>
<li>The <code>nameserver</code> is the IP of the Kubernetes DNS server (like CoreDNS or kube-dns).</li>
<li><code>options ndots:5</code> means a domain must contain at least 5 dots to be considered <strong>fully qualified</strong> (e.g., <code>my-app.default.svc.cluster.local</code>).</li>
</ul>
</li>
<li>
<p><strong>How DNS Resolves <code>my-app</code></strong>:</p>
<ul>
<li>When you type <code>my-app</code>, DNS will append the search domains in order until a match is found or all options are exhausted.</li>
</ul>
<p>For <code>my-app</code>:
- <code>my-app.default.svc.cluster.local</code> → <strong>First try</strong> (because <code>default</code> is the Pod's namespace).
- <code>my-app.svc.cluster.local</code> → If the first fails, check here.
- <code>my-app.cluster.local</code> → If no match, check here.
- Finally, it tries external DNS if none match.</p>
</li>
<li>
<p><strong>In Your Example (<code>my-app</code> in the <code>default</code> namespace)</strong>:</p>
<ul>
<li>When you type <code>my-app</code>, Kubernetes DNS will resolve it to the Service <code>my-app</code> in the same namespace (<code>default</code>) because of the <code>default.svc.cluster.local</code> search path.</li>
</ul>
</li>
<li>
<p><strong>For different namespace (argocd)</strong>:</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code>cat /etc/resolv.conf 
search argocd.svc.cluster.local svc.cluster.local cluster.local
nameserver 10.43.0.10
options ndots:5
</code></pre></div>

<p><strong>Key Takeaway</strong>:
if the Service is named <code>my-app</code> and in the same namespace (<code>default</code>), typing <code>my-app</code> will resolve to <code>my-app.default.svc.cluster.local</code>. This is thanks to the search domain and Kubernetes DNS configuration.</p>
<h4>CoreDNS:</h4>
<ul>
<li>It watches K8S Api for new services, it will creates a DNS record</li>
</ul>
<h4>More notes about the Service:</h4>
<ul>
<li>When a Service is created with a selector, Kubernetes automatically creates an Endpoints object and populates it with the IPs and ports of Pods that match the selector. Whenever the set of Pods matching the selector changes, the Endpoints object is automatically updated.</li>
</ul>
<h1>Conclusion:</h1>
<ul>
<li>with the help of chatGPT, some explanations are much better</li>
<li>re-memorized for my knowledge about k8s networking</li>
</ul>
<h1>What's next in part 2?</h1>
<ul>
<li>CNI</li>
<li>Cilium</li>
<li>And more...</li>
</ul>
<h1>Reference:</h1>
<ul>
<li><a href="https://kubernetes.io/docs/concepts/services-networking/service/">https://kubernetes.io</a></li>
<li><a href="https://bytebytego.com">https://bytebytego.com</a></li>
<li><a href="https://kodekloud.com">https://kodekloud.com</a></li>
</ul>


             
 
            
            
            







            <hr/>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2025-01-17T00:00:00+07:00">Fri 17 January 2025</time>
            <h4>Category</h4>
            <a class="category-link" href="/categories.html#knowledge-base-ref">Knowledge Base</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="/tags.html#k8s-ref">k8s
                    <span class="superscript">7</span>
</a></li>
            </ul>
<h4>Contact</h4>
<div id="sidebar-social-link">
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="/theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>