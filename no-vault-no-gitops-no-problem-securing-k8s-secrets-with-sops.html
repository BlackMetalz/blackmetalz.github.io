<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="https://blackmetalz.github.io/theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://blackmetalz.github.io/theme/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="author" content="kienlt" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="security, k8s, Knowledge Base, " />

<meta property="og:title" content="No Vault? No GitOps? No Problem - Securing K8s Secrets with SOPS "/>
<meta property="og:url" content="https://blackmetalz.github.io/no-vault-no-gitops-no-problem-securing-k8s-secrets-with-sops.html" />
<meta property="og:description" content="" />
<meta property="og:site_name" content="Kienlt&#39;s notebook" />
<meta property="og:article:author" content="kienlt" />
<meta property="og:article:published_time" content="2026-01-31T00:00:00+07:00" />
<meta name="twitter:title" content="No Vault? No GitOps? No Problem - Securing K8s Secrets with SOPS ">
<meta name="twitter:description" content="">

        <title>No Vault? No GitOps? No Problem - Securing K8s Secrets with SOPS  Â· Kienlt&#39;s notebook
</title>
        <link href="https://blackmetalz.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Kienlt&#39;s notebook - Full Atom Feed" />



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="https://blackmetalz.github.io/"><span class=site-name>Kienlt's notebook</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       https://blackmetalz.github.io
                                    >Home</a>
                                </li>
                                <li ><a href="https://blackmetalz.github.io/categories.html">Categories</a></li>
                                <li ><a href="https://blackmetalz.github.io/tags.html">Tags</a></li>
                                <li ><a href="https://blackmetalz.github.io/archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="https://blackmetalz.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="https://blackmetalz.github.io/no-vault-no-gitops-no-problem-securing-k8s-secrets-with-sops.html">
                No Vault? No GitOps? No Problem - Securing K8s Secrets with SOPS
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <h1>Introduction</h1>
<p>There will always be problems that need to be solved, and then solutions come after that to fit the problem. So today I will tell you about it xD</p>
<p>I have a Streamlit application that needs to open to internal access for reporting about AI usage (Copilot/Cursor), to see if they are effective or not, and a Jira sprint, objectives report.</p>
<p>So the only deployment available at that time is only k8s cluster staging that I have access to. And I have no idea how many people have access in there, I don't want to be flagged by Red Team xD.</p>
<p>So what is Red Team (Copied from Google):</p>
<div class="highlight"><pre><span></span><code><span class="nv">A</span><span class="w"> </span><span class="nv">red</span><span class="w"> </span><span class="nv">team</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">group</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">simulates</span><span class="w"> </span><span class="nv">an</span><span class="w"> </span><span class="nv">adversary</span>,<span class="w"> </span><span class="nv">attempts</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">physical</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">digital</span><span class="w"> </span><span class="nv">intrusion</span><span class="w"> </span><span class="nv">against</span><span class="w"> </span><span class="nv">an</span><span class="w"> </span><span class="nv">organization</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">direction</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">organization</span>,<span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="nv">reports</span><span class="w"> </span><span class="nv">back</span><span class="w"> </span><span class="nv">so</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">organization</span><span class="w"> </span><span class="nv">can</span><span class="w"> </span><span class="nv">improve</span><span class="w"> </span><span class="nv">their</span><span class="w"> </span><span class="nv">defenses</span>.<span class="w"> </span><span class="nv">Red</span><span class="w"> </span><span class="nv">teams</span><span class="w"> </span><span class="nv">work</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">organization</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">are</span><span class="w"> </span><span class="nv">hired</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">organization</span>
</code></pre></div>

<p>So to avoid that, I need some solution, at least they can not access my secret env, which contains API keys, login credentials, etc. Because in K8S, a secret is just encoded base64, not encrypted. </p>
<p><img alt="alt text" src="images/2026/01/05.png">
I copied image from this site: https://mirceanton.com/posts/doing-secrets-the-gitops-way/</p>
<hr>
<h1>Why I chose SOPS?</h1>
<p>Before talking about it, I want to show the current state of staging k8s cluster:</p>
<ul>
<li>I'm not the only person who has access to the k8s cluster</li>
<li>No GitOps, ArgoCD</li>
<li>No Vault or External Secrets Operator</li>
<li>Just kubectl apply xD</li>
</ul>
<p>So I need to find a solution to encrypt my secret, and I chose SOPS after getting some recommendations from Claude since it is the best that fit with my condition.</p>
<hr>
<h1>Install locally to generate encrypted file</h1>
<p>You can read detail in here <a href="https://github.com/getsops/sops">https://github.com/getsops/sops</a></p>
<p>So, I expected that you already have <code>sops</code> and <code>age-keygen</code> available.</p>
<h3>1. Generate an Age Key Pair (if you haven't already)</h3>
<p>This creates your private key file (<code>key.txt</code>). This file <strong>must be present in the project root</strong> when you build the Docker image. It is ignored by <code>.gitignore</code> so it won't be committed to Git.</p>
<div class="highlight"><pre><span></span><code>age-keygen<span class="w"> </span>-o<span class="w"> </span>key.txt
<span class="c1"># You will need the public key (from the output or key.txt.pub) for the next step.</span>
</code></pre></div>

<p>Expected output:</p>
<div class="highlight"><pre><span></span><code>Public key: age1dk67a27dugyy964g38s462mjjn32aewzr4a2fy3yuwcd6wmvufrsg0n7ef
</code></pre></div>

<p>It also generated a private key file (<code>key.txt</code>), which you should keep secure.</p>
<h3>2. Encrypt dotenv secret</h3>
<p>Create this file <code>.sops.yaml</code>:</p>
<div class="highlight"><pre><span></span><code><span class="p">#</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">tells</span><span class="w"> </span><span class="n">sops</span><span class="w"> </span><span class="n">how</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">encrypt</span><span class="o">/</span><span class="n">decrypt</span><span class="w"> </span><span class="n">files</span><span class="p">.</span>
<span class="nl">creation_rules:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nl">path_regex:</span><span class="w"> </span><span class="n">\.env\.enc$</span><span class="w"> </span><span class="p">#</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">regex</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">correctly</span><span class="w"> </span><span class="n">matches</span><span class="w"> </span><span class="n">files</span><span class="w"> </span><span class="n">ending</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="p">.</span><span class="n">env</span><span class="p">.</span><span class="n">enc</span>
<span class="w">    </span><span class="p">#</span><span class="w"> </span><span class="n">Your</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">key</span>
<span class="w">    </span><span class="nl">age:</span><span class="w"> </span><span class="s">&quot;age1dk67a27dugyy964g38s462mjjn32aewzr4a2fy3yuwcd6wmvufrsg0n7ef&quot;</span>
</code></pre></div>

<p>Run following command:</p>
<div class="highlight"><pre><span></span><code>sops<span class="w"> </span>--encrypt<span class="w"> </span>--age<span class="w"> </span>age1dk67a27dugyy964g38s462mjjn32aewzr4a2fy3yuwcd6wmvufrsg0n7ef<span class="w"> </span>.env<span class="w"> </span>&gt;<span class="w"> </span>.env.enc
</code></pre></div>

<p>Expected output of file <code>.env.enc</code>:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w"> </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ENC[AES256_GCM,data:adasdasdasdasd,type:str]&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;sops&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;age&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;recipient&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;age1dk67a27dugyy964g38s462mjjn32aewzr4a2fy3yuwcd6wmvufrsg0n7ef&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;enc&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;-----BEGIN AGE ENCRYPTED FILE-----\somethingsecrethereLOLLLn-----END AGE ENCRYPTED FILE-----\n&quot;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;lastmodified&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2026-01-30T04:31:13Z&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;mac&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ENC[AES256_GCM,data:aaasddsadadasda==,type:str]&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;3.11.0&quot;</span>
<span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>You can test decrypt it with:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">AGE_KEY_FILE</span><span class="o">=</span>key.txt<span class="w"> </span><span class="c1"># Set environment variable</span>
sops<span class="w"> </span>--decrypt<span class="w"> </span>--input-type<span class="w"> </span>json<span class="w"> </span>--output-type<span class="w"> </span>binary<span class="w"> </span>.env.enc<span class="w"> </span>&gt;<span class="w"> </span>env.decrypted
</code></pre></div>

<p>And check output by read content of <code>env.decrypted</code> file.</p>
<h3>3. Create secret and build Dockerfile for it</h3>
<p>Create secret from file: with this, you don't care about people with access can decode the secret xD</p>
<div class="highlight"><pre><span></span><code><span class="c1"># The key is: encrypted.env. Value is content of .env.enc</span>
kubectl<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>generic<span class="w"> </span>my-secret<span class="w"> </span>--from-file<span class="o">=</span>encrypted.env<span class="o">=</span>.env.enc
</code></pre></div>

<p>Dockerfile for that shit, you will notice that I did removed shell from final image. So in that scenario those with k8s cluster access won't be able to enter into container to decode the secret xD</p>
<p>But you need to keep <code>key.txt</code> and build image manually, it is not possible to put <code>key.txt</code> into git repo and use pipeline for CICD in there.</p>
<div class="highlight"><pre><span></span><code><span class="c"># Stage 1: Builder</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.12-alpine</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">builder</span>

<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>
<span class="k">RUN</span><span class="w"> </span>apk<span class="w"> </span>add<span class="w"> </span>--no-cache<span class="w"> </span>build-base<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--no-cache-dir<span class="w"> </span><span class="nv">pip</span><span class="o">==</span><span class="m">25</span>.3

<span class="k">RUN</span><span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>/opt/venv
<span class="k">ENV</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;/opt/venv/bin:</span><span class="nv">$PATH</span><span class="s2">&quot;</span>

<span class="k">COPY</span><span class="w"> </span>requirements.txt<span class="w"> </span>.
<span class="k">RUN</span><span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--no-cache-dir<span class="w"> </span>-r<span class="w"> </span>requirements.txt

<span class="c"># Stage 2: Runner</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.12-alpine</span>

<span class="k">ENV</span><span class="w"> </span><span class="nv">PYTHONDONTWRITEBYTECODE</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="nv">PYTHONUNBUFFERED</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;/opt/venv/bin:</span><span class="nv">$PATH</span><span class="s2">&quot;</span>

<span class="c"># Upgrade pip</span>
<span class="k">RUN</span><span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--no-cache-dir<span class="w"> </span><span class="nv">pip</span><span class="o">==</span><span class="m">25</span>.3

<span class="c"># Install sops and jq, then remove shell-related packages</span>
<span class="c"># Note: --no-check-certificate is used due to corporate proxy limitations</span>
<span class="k">RUN</span><span class="w"> </span>apk<span class="w"> </span>add<span class="w"> </span>--no-cache<span class="w"> </span>wget<span class="w"> </span>jq<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="nv">SOPS_VERSION</span><span class="o">=</span><span class="s2">&quot;v3.11.0&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>wget<span class="w"> </span><span class="s2">&quot;https://github.com/getsops/sops/releases/download/</span><span class="si">${</span><span class="nv">SOPS_VERSION</span><span class="si">}</span><span class="s2">/sops-</span><span class="si">${</span><span class="nv">SOPS_VERSION</span><span class="si">}</span><span class="s2">.linux.amd64&quot;</span><span class="w"> </span>--no-check-certificate<span class="w"> </span>-O<span class="w"> </span>/usr/local/bin/sops<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>chmod<span class="w"> </span>+x<span class="w"> </span>/usr/local/bin/sops<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>apk<span class="w"> </span>del<span class="w"> </span>wget

<span class="c"># Create user (still need shadow temporarily)</span>
<span class="k">RUN</span><span class="w"> </span>apk<span class="w"> </span>add<span class="w"> </span>--no-cache<span class="w"> </span>shadow<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>groupadd<span class="w"> </span>-g<span class="w"> </span><span class="m">1000</span><span class="w"> </span>appuser<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>useradd<span class="w"> </span>-u<span class="w"> </span><span class="m">1000</span><span class="w"> </span>-r<span class="w"> </span>-g<span class="w"> </span>appuser<span class="w"> </span>-d<span class="w"> </span>/app<span class="w"> </span>appuser<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>apk<span class="w"> </span>del<span class="w"> </span>shadow

<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>

<span class="c"># Copy virtual environment</span>
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder<span class="w"> </span>/opt/venv<span class="w"> </span>/opt/venv

<span class="c"># Copy source code and entrypoint</span>
<span class="k">COPY</span><span class="w"> </span>.<span class="w"> </span>.
<span class="k">COPY</span><span class="w"> </span>entrypoint.py<span class="w"> </span>/app/entrypoint.py
<span class="k">RUN</span><span class="w"> </span>chmod<span class="w"> </span>+x<span class="w"> </span>/app/entrypoint.py

<span class="c"># Copy age key</span>
<span class="k">RUN</span><span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/etc/.yolo
<span class="k">COPY</span><span class="w"> </span>key.txt<span class="w"> </span>/etc/.yolo/key.txt
<span class="k">RUN</span><span class="w"> </span>chown<span class="w"> </span>-R<span class="w"> </span>appuser:appuser<span class="w"> </span>/app<span class="w"> </span>/etc/.yolo

<span class="c"># Remove shells (bash, sh, ash)</span>
<span class="k">RUN</span><span class="w"> </span>rm<span class="w"> </span>-f<span class="w"> </span>/bin/sh<span class="w"> </span>/bin/ash<span class="w"> </span>/bin/bash<span class="w"> </span>/usr/bin/sh<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="o">||</span><span class="w"> </span>true

<span class="k">USER</span><span class="w"> </span><span class="s">appuser</span>

<span class="k">EXPOSE</span><span class="w"> </span><span class="s">8501</span>

<span class="c"># Use exec form to avoid shell</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;python3&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;/app/entrypoint.py&quot;</span><span class="p">]</span>
</code></pre></div>

<p>And important for runtime decryption <code>entrypoint.py</code>. I create this script to decrypt the secret at runtime then start the application.</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">ENCRYPTED_SECRET_PATH</span> <span class="o">=</span> <span class="s2">&quot;/etc/secrets/encrypted.env&quot;</span>
<span class="n">AGE_KEY_FILE</span> <span class="o">=</span> <span class="s2">&quot;/etc/.yolo/key.txt&quot;</span>
<span class="n">DECRYPTED_ENV_PATH</span> <span class="o">=</span> <span class="s2">&quot;/app/.env&quot;</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attempting to decrypt secret...&quot;</span><span class="p">)</span>

    <span class="c1"># Check files exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ENCRYPTED_SECRET_PATH</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: Encrypted secret file not found at </span><span class="si">{</span><span class="n">ENCRYPTED_SECRET_PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">AGE_KEY_FILE</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: Age private key file not found at </span><span class="si">{</span><span class="n">AGE_KEY_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Read age key</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">AGE_KEY_FILE</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">age_key</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">age_key</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: Age private key file is empty or could not be read.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Set SOPS_AGE_KEY environment variable</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">env</span><span class="p">[</span><span class="s1">&#39;SOPS_AGE_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">age_key</span>

    <span class="c1"># Detect format</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ENCRYPTED_SECRET_PATH</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">first_char</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Decrypt</span>
    <span class="k">if</span> <span class="n">first_char</span> <span class="o">==</span> <span class="s1">&#39;{&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Detected JSON format (binary encrypted)&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/usr/local/bin/sops&#39;</span><span class="p">,</span> <span class="s1">&#39;--decrypt&#39;</span><span class="p">,</span> <span class="s1">&#39;--input-type&#39;</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="s1">&#39;--output-type&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span> <span class="n">ENCRYPTED_SECRET_PATH</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Detected dotenv format&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/usr/local/bin/sops&#39;</span><span class="p">,</span> <span class="s1">&#39;--decrypt&#39;</span><span class="p">,</span> <span class="n">ENCRYPTED_SECRET_PATH</span><span class="p">]</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">DECRYPTED_ENV_PATH</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: Decryption failed: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># print(f&quot;Secret decrypted successfully to {DECRYPTED_ENV_PATH}&quot;)</span>

    <span class="c1"># Show first 1 lines (for debugging)</span>
    <span class="c1"># with open(DECRYPTED_ENV_PATH, &#39;r&#39;) as f:</span>
    <span class="c1">#     for i, line in enumerate(f):</span>
    <span class="c1">#         if i &gt;= 1:</span>
    <span class="c1">#             break</span>
    <span class="c1">#         print(f&quot;Line {i+1}: {line.rstrip()}&quot;)</span>

    <span class="c1"># Start Streamlit</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting Streamlit application...&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">execvp</span><span class="p">(</span><span class="s1">&#39;streamlit&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;streamlit&#39;</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="s1">&#39;report.py&#39;</span><span class="p">,</span> <span class="s1">&#39;--server.address=0.0.0.0&#39;</span><span class="p">])</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>

<h3>4. Deploy to k8s</h3>
<p>Here is my sample deployment, I create service so I know which user for securityContext and yeah Sonarqube is annoying, it force me to put resource request and limit, haha</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reporting-dashboard</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dashboard-analytics</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reporting-dashboard</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reporting-dashboard</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reporting-dashboard</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># non-root (appuser - 1000) defined in Dockerfile</span>
<span class="w">      </span><span class="nt">automountServiceAccountToken</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span>
<span class="w">        </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
<span class="w">        </span><span class="nt">runAsGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
<span class="w">        </span><span class="nt">fsGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
<span class="w">        </span><span class="nt">runAsNonRoot</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="nt">imagePullSecrets</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">secret-for-pull-image-here</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dashboard</span>
<span class="w">        </span><span class="nt">securityContext</span><span class="p">:</span>
<span class="w">          </span><span class="nt">allowPrivilegeEscalation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">your-image-here:v1.2.3</span>
<span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8501</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<span class="w">        </span><span class="c1"># New: Mount encrypted secret and age key for runtime decryption</span>
<span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">encrypted-secret</span>
<span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/secrets/encrypted.env</span>
<span class="w">          </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">encrypted.env</span><span class="w"> </span><span class="c1"># Mounts the &#39;encrypted.env&#39; key from the secret as a file</span>
<span class="w">          </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">        </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">          </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;200m&quot;</span>
<span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;256Mi&quot;</span>
<span class="w">          </span><span class="nt">limits</span><span class="p">:</span>
<span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1000m&quot;</span>
<span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1Gi&quot;</span>
<span class="w">            </span><span class="nt">ephemeral-storage</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;5Gi&quot;</span>
<span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># New: Define volumes for the encrypted secret</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">encrypted-secret</span>
<span class="w">        </span><span class="nt">secret</span><span class="p">:</span>
<span class="w">          </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-secret</span>
<span class="w">          </span><span class="nt">items</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">encrypted.env</span>
<span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">encrypted.env</span>
</code></pre></div>

<p>That's all, I think it's the best solution for me in this case!</p>
<hr>
<h1>Conclusion</h1>
<p>Trade-off: Only able to save you from lazy attackers. Not from determination attackers.</p>
<ul>
<li>Risk: if anyone has access to image registry or pull image, they can get the key.txt and decrypt the secret. So make sure your image registry is secure. In fact, you'll still be fucked if someone has access to your k8s cluster. Can't hide the image pull secret. </li>
<li>How to mitigate: Make sure your image registry is secure and only authorized users can pull images.</li>
</ul>
<p>Something fun I learned:</p>
<ul>
<li><code>sops</code> for encryption/decryption</li>
<li><code>age</code> for key management</li>
<li>Just remove fucking shell from container. A little hard to debug but I'm capable of doing that via logging, I don't need to use shell in container for debugging. I think it's a good practice for security. And yeah, I know how the application works since I'm the only developer in that project.</li>
<li>Sonarqube is annoying but worth it, it forces me to put resource request and limit if I don't want to see a lot of warning.</li>
</ul>
<p>I'm using this solution because it just matched for my case. It's simple, secure, and easy to maintain.</p>


             
 
            
            
            







            <hr/>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2026-01-31T00:00:00+07:00">Sat 31 January 2026</time>
            <h4>Category</h4>
            <a class="category-link" href="https://blackmetalz.github.io/categories.html#knowledge-base-ref">Knowledge Base</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="https://blackmetalz.github.io/tags.html#k8s-ref">k8s
                    <span class="superscript">12</span>
</a></li>
                <li><a href="https://blackmetalz.github.io/tags.html#security-ref">security
                    <span class="superscript">2</span>
</a></li>
            </ul>
<h4>Contact</h4>
<div id="sidebar-social-link">
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="https://blackmetalz.github.io/theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>