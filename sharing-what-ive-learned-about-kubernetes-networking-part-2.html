<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="/theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="author" content="kienlt" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="k8s, Knowledge Base, " />

<meta property="og:title" content="Sharing What I&#39;ve Learned About Kubernetes Networking - Part 2 "/>
<meta property="og:url" content="/sharing-what-ive-learned-about-kubernetes-networking-part-2.html" />
<meta property="og:description" content="" />
<meta property="og:site_name" content="Kienlt&#39;s notebook" />
<meta property="og:article:author" content="kienlt" />
<meta property="og:article:published_time" content="2025-01-20T00:00:00+07:00" />
<meta name="twitter:title" content="Sharing What I&#39;ve Learned About Kubernetes Networking - Part 2 ">
<meta name="twitter:description" content="">

        <title>Sharing What I&#39;ve Learned About Kubernetes Networking - Part 2  · Kienlt&#39;s notebook
</title>



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="/"><span class=site-name>Kienlt's notebook</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       "/"
                                    >Home</a>
                                </li>
                                <li ><a href="/categories.html">Categories</a></li>
                                <li ><a href="/tags.html">Tags</a></li>
                                <li ><a href="/archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="/sharing-what-ive-learned-about-kubernetes-networking-part-2.html">
                Sharing What I've Learned About Kubernetes Networking - Part 2
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <p>In the second part, I will talk about Container network interface (CNI), Cilium CNI and some compare with Network policies and Cilium network policies.</p>
<h1>CNI</h1>
<h3>What is CNI:</h3>
<ul>
<li>Is a framework for configuring network interfaces in Linux containers, providing connectivity, and ensuring network isolation.</li>
<li>CNI Plugin standardizes and simplifies Kubernetes networking.</li>
</ul>
<h3>How CNI Works:</h3>
<ul>
<li>CNI works by invoking a network plugin that handles network configuration for containers. When a container is created, the container runtime calls the CNI plugin to set the container network interface.</li>
<li>Works in K8S:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">Kube</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">Kubelet</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">Container</span><span class="w"> </span><span class="n">Runtime</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">container</span><span class="p">,</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="n">namespace</span>
<span class="w">                                           </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="n">CNI</span><span class="p">,</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">for</span><span class="w"> </span><span class="n">veth</span><span class="w"> </span><span class="n">then</span><span class="w"> </span><span class="nf">map</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">container</span><span class="w"> </span><span class="n">network</span>
</code></pre></div>

<h3>CNI specification:</h3>
<ul>
<li>A Json configuration file that specifies the desired network setup.</li>
<li>Standard commands: ADD, DEL, CHECK to manage network interfaces.</li>
<li>The plugin must handle these commands and return results in a  predefined format.</li>
</ul>
<h3>CNI community popularity:</h3>
<p>The following table summarizes different GitHub metrics to give you an idea of each project's popularity and activity levels. This data was collected in December 2024.</p>
<table>
<thead>
<tr>
<th>Provider</th>
<th>Stars</th>
<th>Forks</th>
<th>Contributors</th>
</tr>
</thead>
<tbody>
<tr>
<td>Canal</td>
<td>718</td>
<td>100</td>
<td>20</td>
</tr>
<tr>
<td>Flannel</td>
<td>8.9k</td>
<td>2.9k</td>
<td>234</td>
</tr>
<tr>
<td>Calico</td>
<td>6.1k</td>
<td>1.4k</td>
<td>360</td>
</tr>
<tr>
<td>Weave</td>
<td>6.6k</td>
<td>672</td>
<td>84</td>
</tr>
<tr>
<td>Cilium</td>
<td>20.5k</td>
<td>3k</td>
<td>868</td>
</tr>
</tbody>
</table>
<h1>Cilium CNI</h1>
<h3>What is Cilium</h3>
<p>Cilium is an open-source networking and security solution designed for Kubernetes and other container orchestration platforms. Its primary purpose is to provide secure and efficient network connectivity between application services deployed in cloud-native environments. Cilium leverages <code>eBPF</code> (extended Berkeley Packet Filter) technology to dynamically insert code into the Linux kernel, enabling high-performance packet processing and security enforcement.</p>
<p>As a CNI (Container Network Interface) plugin, Cilium offers advanced networking features, robust security policies, and deep observability capabilities. These features make it an ideal choice for modern cloud-native applications that require scalable and secure network infrastructure.</p>
<h3>Key Features</h3>
<ul>
<li>
<p><strong>eBPF</strong>
Cilium uses eBPF to dynamically insert code into the Linux kernel, enabling efficient packet processing and security enforcement.</p>
</li>
<li>
<p><strong>Network Policies</strong>
Cilium implements Kubernetes Network Policies and extends them with more advanced features, allowing fine-grained control over network traffic.</p>
</li>
<li>
<p><strong>Service Mesh Integration</strong>
Cilium integrates seamlessly with service meshes like Istio, providing enhanced networking capabilities and security. ( right now i have no idea about this. xD)</p>
</li>
<li>
<p><strong>Observability</strong>
Cilium offers robust observability features through <code>Hubble</code>, which provides deep visibility into network traffic and security events.</p>
</li>
</ul>
<h3>eBPF explain</h3>
<p>I think you haven't understood clearly about eBPF (so am i), so i tried to spend time reading the document, trying to understand it and explain it here xD.</p>
<h4>1. <strong>Think of it as a plugin system for the kernel</strong> that can help with monitoring, networking, and security:</h4>
<ul>
<li>Observe: Watch what’s happening inside the system (e.g., track network packets, file operations, etc.).</li>
<li>Act: Modify or filter data in real time (e.g., drop a suspicious network packet).</li>
</ul>
<h4>2. <strong>Why is it useful?</strong>:</h4>
<p>Normally, to add new functionality to the Linux kernel, you'd have to rebuild or modify the kernel—a risky and complex task. eBPF solves this by:
- Letting you "inject" tiny programs dynamically.
- Running these programs in a safe sandbox to ensure they can’t crash or harm the system.
- Being fast because the programs run directly inside the kernel.</p>
<h4>3. <strong>Simple Analogy</strong>: Imagine the Linux kernel is a busy post office:</h4>
<ul>
<li>Every day, it processes letters (network packets, file reads, system events).</li>
<li>If you wanted to filter out spam mail (e.g., suspicious packets), you'd normally need to rewrite the post office's internal processes (modify the kernel).</li>
<li>But with eBPF, you can simply write a small "mailroom plugin" that works alongside the post office to filter spam as the letters pass through without changing how the post office works.</li>
</ul>
<h4>4. <strong>Example: Network Packet Filtering</strong>. Let’s say you want to block network packets coming from a suspicious IP address.</h4>
<ul>
<li><strong>Without eBPF</strong>:<ul>
<li>You might need to install complex tools or write custom firewall rules.</li>
<li>Or, you’d need to modify the kernel, which is risky.</li>
</ul>
</li>
<li><strong>With eBPF</strong>:<ul>
<li>You write a small eBPF program in C or a high-level language like Python (with libraries like bcc or libbpf).</li>
<li>This program runs inside the kernel and checks every network packet:<ul>
<li>If the packet’s source IP matches the bad one, the program drops it.</li>
<li>Otherwise, it lets the packet through.</li>
</ul>
</li>
<li>You load the eBPF program dynamically using tools like bpftool.</li>
</ul>
</li>
</ul>
<h4>5. <strong>Additional example of how network packet filter</strong>:</h4>
<p>I think i need some example code for easier imagination, the same method which i used to better understand the issue.</p>
<ul>
<li><strong>Install required for Debian-based system</strong>:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">sudo</span><span class="w"> </span><span class="n">apt</span><span class="o">-</span><span class="n">get</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">bpfcc</span><span class="o">-</span><span class="n">tools</span><span class="w"> </span><span class="n">linux</span><span class="o">-</span><span class="n">headers</span><span class="o">-$</span><span class="p">(</span><span class="n">uname</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="p">)</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">apt</span><span class="o">-</span><span class="n">get</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">python3</span><span class="o">-</span><span class="n">bpfcc</span>
</code></pre></div>

<ul>
<li><strong>Write the eBPF Program</strong>:
Create a file called filter.c containing the eBPF program. This program checks the destination port of each packet and drops packets destined for port 3306.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;uapi/linux/bpf.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;uapi/linux/if_ether.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;uapi/linux/ip.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;uapi/linux/tcp.h&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">drop_port_3306</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">__sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Get the Ethernet header</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ethhdr</span><span class="w"> </span><span class="o">*</span><span class="n">eth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_hdr_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">eth</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Check if the packet is an IP packet</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">iphdr</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_hdr_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eth</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ip</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Check if the packet is a TCP packet</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">IPPROTO_TCP</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcphdr</span><span class="w"> </span><span class="o">*</span><span class="n">tcp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_hdr_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eth</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ip</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tcp</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Check if the destination port is 3306</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">dest</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">htons</span><span class="p">(</span><span class="mi">3306</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Drop the packet</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TC_ACT_SHOT</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Allow the packet</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">TC_ACT_OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<ul>
<li><strong>Load and Attach the eBPF Program</strong>:
Create a Python script filter.py that uses the bcc library to load and attach the eBPF program to the network interface.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">bcc</span> <span class="kn">import</span> <span class="n">BPF</span>

<span class="c1"># Load the eBPF program from the C file</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">BPF</span><span class="p">(</span><span class="n">src_file</span><span class="o">=</span><span class="s2">&quot;filter.c&quot;</span><span class="p">,</span> <span class="n">cflags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-w&quot;</span><span class="p">])</span>
<span class="n">function_skb</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">load_func</span><span class="p">(</span><span class="s2">&quot;drop_port_3306&quot;</span><span class="p">,</span> <span class="n">BPF</span><span class="o">.</span><span class="n">SCHED_CLS</span><span class="p">)</span>

<span class="c1"># Attach the eBPF program to the network interface (e.g., eth0)</span>
<span class="n">INTERFACE</span> <span class="o">=</span> <span class="s2">&quot;eth0&quot;</span>
<span class="n">b</span><span class="o">.</span><span class="n">attach_skb_filter</span><span class="p">(</span><span class="n">function_skb</span><span class="p">,</span> <span class="n">INTERFACE</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;eBPF program loaded and attached to </span><span class="si">{</span><span class="n">INTERFACE</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dropping packets destined for port 3306...&quot;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">b</span><span class="o">.</span><span class="n">trace_print</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Detaching program and exiting...&quot;</span><span class="p">)</span>
    <span class="n">b</span><span class="o">.</span><span class="n">remove_skb_filter</span><span class="p">(</span><span class="n">function_skb</span><span class="p">,</span> <span class="n">INTERFACE</span><span class="p">)</span>
</code></pre></div>

<ul>
<li>
<p><strong>Explanation</strong>:</p>
<ul>
<li><strong>filter.c</strong>: This file contains the eBPF program written in C. It checks if the packet is an IP packet and a TCP packet. It then checks if the destination port is 3306 and drops the packet if true.</li>
<li><strong>filter.py</strong>: This Python script uses the bcc library to load the eBPF program from filter.c and attach it to a network interface (e.g., eth0). The trace_print function prints trace messages until the program is interrupted</li>
</ul>
</li>
<li>
<p><strong>Running the Program</strong>:</p>
<ol>
<li>Save the eBPF program in a file named filter.c.</li>
<li>Save the Python script in a file named filter.py.</li>
<li>Run the Python script using:
<code>sh
sudo python3 filter.py</code>
This will load the eBPF program and attach it to the specified network interface (<code>eth0</code>), dropping any packet destined for port 3306.</li>
</ol>
</li>
</ul>
<p><strong>P/s: This is generated from Copilot xD</strong>, but it should give an idea of why eBPF is strong and useful.</p>
<h3>Cilium eBPF</h3>
<ul>
<li>First, i think you need to check if Cilium is enabled in hybrid mode or strict mode or not</li>
</ul>
<div class="highlight"><pre><span></span><code>kubectl -n kube-system edit configmap cilium-config
</code></pre></div>

<p>Looks for line <code>kube-proxy-replacement</code>, if it is empty (<code>""</code>), it is running in hybrid mode and you can see by type <code>iptables -L</code>. Enable it with </p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nt">kube-proxy-replacement</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">strict</span>
<span class="w">  </span><span class="nt">kube-proxy-replacement-healthz-bind-address</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">  </span><span class="nt">enable-l7-proxy</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
</code></pre></div>

<ul>
<li>
<p>Second, check kernel support or not: Cilium generally requires a kernel version &gt;= 4.19 for basic eBPF functionality and &gt;= 5.4 for kube-proxy replacement. So it will mostly be about supported xD</p>
</li>
<li>
<p>Third, let's focus on the main objective.</p>
<ul>
<li>Cilium with eBPF is generally faster than iptables. eBPF (extended Berkeley Packet Filter) allows Cilium to dynamically insert code into the Linux kernel, enabling efficient packet processing and security enforcement. This approach reduces the overhead associated with traditional iptables-based packet filtering and routing.</li>
<li>Iptables operate in user space and rely on a series of rules to manage network traffic, which can become complex and slow as the number of rules increases. In contrast, eBPF operates in the kernel space, allowing for more direct and efficient handling of network packets. This results in lower latency and higher throughput, making Cilium with eBPF a more performant solution for Kubernetes networking.</li>
</ul>
</li>
</ul>
<p><a href="https://x.com/diptanu/status/899424568422486016">Check out this tweet</a></p>
<ul>
<li>Examples of how Cilium utilizes eBPF: Load Balancing<ul>
<li>Use Case: Cilium implements a high-performance, distributed load balancer for Kubernetes services</li>
<li>eBPF Functionality:<ul>
<li>eBPF programs attached to networking hooks can direct packets to the correct backend pod without relying on iptables.</li>
<li>Example: A packet arriving for ClusterIP is intercepted by an eBPF program, which selects a pod backend based on a consistent hash algorithm and forwards the packet directly.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>More examples can be found here: <a href="https://archive.fosdem.org/2020/schedule/event/replacing_iptables_with_ebpf/attachments/slides/3622/export/events/attachments/replacing_iptables_with_ebpf/slides/3622/Cilium_FOSDEM_2020.pdf">replacing_iptables_with_ebpf</a></p>
<h3>Common commands of the cilium</h3>
<div class="highlight"><pre><span></span><code>cilium-health status
cilium status
</code></pre></div>

<h3>Cilium Observability: Hubble</h3>
<ul>
<li>There are many ways to enable Hubble and Hubble UI, so i won't talk details here.</li>
<li>View network flows in real-time: <code>hubble observe</code></li>
<li>Port forward to use Hubble UI: <code>kubectl port-forward -n kube-system svc/hubble-ui 12000:80</code>
<img alt="alt text" src="images/2025/01/20th_1.png"></li>
<li>
<p>As you can see, very useful for Observability, debugging, and tracing!, even more, it shows which packets get dropped so we can have an  idea of where to check, at this point, it is caused by CNP (Cilium Network Policy).
<img alt="alt text" src="images/2025/01/20th_2.png"></p>
</li>
<li>
<p>For CLI mode which i prefer for debugging xD</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Show full info with follow</span>
<span class="n">hubble</span><span class="w"> </span><span class="n">observe</span><span class="w"> </span><span class="o">-</span><span class="n">f</span>
<span class="n">Jan</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="mi">09</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">11.844</span><span class="p">:</span><span class="w"> </span><span class="mf">10.42</span><span class="o">.</span><span class="mf">2.237</span><span class="p">:</span><span class="mi">45738</span><span class="w"> </span><span class="p">(</span><span class="k">remote</span><span class="o">-</span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">cattle</span><span class="o">-</span><span class="n">monitoring</span><span class="o">-</span><span class="n">system</span><span class="o">/</span><span class="n">rancher</span><span class="o">-</span><span class="n">monitoring</span><span class="o">-</span><span class="n">prometheus</span><span class="o">-</span><span class="n">adapter</span><span class="o">-</span><span class="mi">67</span><span class="n">bc4c68b6</span><span class="o">-</span><span class="n">v4txm</span><span class="p">:</span><span class="mi">6443</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="p">:</span><span class="mi">45221</span><span class="p">)</span><span class="w"> </span><span class="n">to</span><span class="o">-</span><span class="n">overlay</span><span class="w"> </span><span class="n">FORWARDED</span><span class="w"> </span><span class="p">(</span><span class="n">TCP</span><span class="w"> </span><span class="n">Flags</span><span class="p">:</span><span class="w"> </span><span class="n">ACK</span><span class="p">,</span><span class="w"> </span><span class="n">PSH</span><span class="p">)</span>
<span class="n">Jan</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="mi">09</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">11.844</span><span class="p">:</span><span class="w"> </span><span class="mf">10.42</span><span class="o">.</span><span class="mf">2.237</span><span class="p">:</span><span class="mi">45738</span><span class="w"> </span><span class="p">(</span><span class="n">host</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">cattle</span><span class="o">-</span><span class="n">monitoring</span><span class="o">-</span><span class="n">system</span><span class="o">/</span><span class="n">rancher</span><span class="o">-</span><span class="n">monitoring</span><span class="o">-</span><span class="n">prometheus</span><span class="o">-</span><span class="n">adapter</span><span class="o">-</span><span class="mi">67</span><span class="n">bc4c68b6</span><span class="o">-</span><span class="n">v4txm</span><span class="p">:</span><span class="mi">6443</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="p">:</span><span class="mi">45221</span><span class="p">)</span><span class="w"> </span><span class="n">to</span><span class="o">-</span><span class="n">overlay</span><span class="w"> </span><span class="n">FORWARDED</span><span class="w"> </span><span class="p">(</span><span class="n">TCP</span><span class="w"> </span><span class="n">Flags</span><span class="p">:</span><span class="w"> </span><span class="n">ACK</span><span class="p">,</span><span class="w"> </span><span class="n">PSH</span><span class="p">)</span>
<span class="n">Jan</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="mi">09</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">11.844</span><span class="p">:</span><span class="w"> </span><span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">59934</span><span class="w"> </span><span class="p">(</span><span class="n">host</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mf">10.0</span><span class="o">.</span><span class="mf">0.2</span><span class="p">:</span><span class="mi">8472</span><span class="w"> </span><span class="p">(</span><span class="k">remote</span><span class="o">-</span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="n">to</span><span class="o">-</span><span class="n">network</span><span class="w"> </span><span class="n">FORWARDED</span><span class="w"> </span><span class="p">(</span><span class="n">UDP</span><span class="p">)</span>
<span class="c1"># Filter for specific from pod:  hubble observe --from-pod &lt;namespace&gt;/&lt;pod-name&gt;.</span>
<span class="c1"># But it doesn&#39;t show packet is dropped duo Cilium network policy (continue read and you will see)</span>
<span class="n">Jan</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="mi">09</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mf">09.436</span><span class="p">:</span><span class="w"> </span><span class="n">default</span><span class="o">/</span><span class="n">kienlt</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">tools</span><span class="p">:</span><span class="mi">39036</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="p">:</span><span class="mi">46060</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">kube</span><span class="o">-</span><span class="n">system</span><span class="o">/</span><span class="n">rke2</span><span class="o">-</span><span class="n">coredns</span><span class="o">-</span><span class="n">rke2</span><span class="o">-</span><span class="n">coredns</span><span class="o">-</span><span class="mi">565</span><span class="n">dfc7d75</span><span class="o">-</span><span class="mi">78</span><span class="n">ql9</span><span class="p">:</span><span class="mi">53</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="p">:</span><span class="mi">8648</span><span class="p">)</span><span class="w"> </span><span class="n">policy</span><span class="o">-</span><span class="n">verdict</span><span class="p">:</span><span class="n">all</span><span class="w"> </span><span class="n">INGRESS</span><span class="w"> </span><span class="n">ALLOWED</span><span class="w"> </span><span class="p">(</span><span class="n">UDP</span><span class="p">)</span>
<span class="n">Jan</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="mi">09</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mf">09.436</span><span class="p">:</span><span class="w"> </span><span class="n">default</span><span class="o">/</span><span class="n">kienlt</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">tools</span><span class="p">:</span><span class="mi">39036</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="p">:</span><span class="mi">46060</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">kube</span><span class="o">-</span><span class="n">system</span><span class="o">/</span><span class="n">rke2</span><span class="o">-</span><span class="n">coredns</span><span class="o">-</span><span class="n">rke2</span><span class="o">-</span><span class="n">coredns</span><span class="o">-</span><span class="mi">565</span><span class="n">dfc7d75</span><span class="o">-</span><span class="mi">78</span><span class="n">ql9</span><span class="p">:</span><span class="mi">53</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="p">:</span><span class="mi">8648</span><span class="p">)</span><span class="w"> </span><span class="n">to</span><span class="o">-</span><span class="n">endpoint</span><span class="w"> </span><span class="n">FORWARDED</span><span class="w"> </span><span class="p">(</span><span class="n">UDP</span><span class="p">)</span>
<span class="n">Jan</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="mi">09</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mf">09.436</span><span class="p">:</span><span class="w"> </span><span class="n">default</span><span class="o">/</span><span class="n">kienlt</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">tools</span><span class="p">:</span><span class="mi">39036</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="p">:</span><span class="mi">46060</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">kube</span><span class="o">-</span><span class="n">system</span><span class="o">/</span><span class="n">rke2</span><span class="o">-</span><span class="n">coredns</span><span class="o">-</span><span class="n">rke2</span><span class="o">-</span><span class="n">coredns</span><span class="o">-</span><span class="mi">565</span><span class="n">dfc7d75</span><span class="o">-</span><span class="mi">78</span><span class="n">ql9</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="p">:</span><span class="mi">8648</span><span class="p">)</span><span class="w"> </span><span class="n">pre</span><span class="o">-</span><span class="n">xlate</span><span class="o">-</span><span class="n">rev</span><span class="w"> </span><span class="n">TRACED</span><span class="w"> </span><span class="p">(</span><span class="n">UDP</span><span class="p">)</span>
<span class="n">Jan</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="mi">09</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mf">09.436</span><span class="p">:</span><span class="w"> </span><span class="n">default</span><span class="o">/</span><span class="n">kienlt</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">tools</span><span class="p">:</span><span class="mi">39036</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="p">:</span><span class="mi">46060</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">kube</span><span class="o">-</span><span class="n">system</span><span class="o">/</span><span class="n">rke2</span><span class="o">-</span><span class="n">coredns</span><span class="o">-</span><span class="n">rke2</span><span class="o">-</span><span class="n">coredns</span><span class="o">-</span><span class="mi">565</span><span class="n">dfc7d75</span><span class="o">-</span><span class="mi">78</span><span class="n">ql9</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="p">:</span><span class="mi">8648</span><span class="p">)</span><span class="w"> </span><span class="n">pre</span><span class="o">-</span><span class="n">xlate</span><span class="o">-</span><span class="n">rev</span><span class="w"> </span><span class="n">TRACED</span><span class="w"> </span><span class="p">(</span><span class="n">UDP</span><span class="p">)</span>
<span class="n">Jan</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="mi">09</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mf">09.440</span><span class="p">:</span><span class="w"> </span><span class="n">default</span><span class="o">/</span><span class="n">kienlt</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">tools</span><span class="p">:</span><span class="mi">54729</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="p">:</span><span class="mi">46060</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">kube</span><span class="o">-</span><span class="n">system</span><span class="o">/</span><span class="n">rke2</span><span class="o">-</span><span class="n">coredns</span><span class="o">-</span><span class="n">rke2</span><span class="o">-</span><span class="n">coredns</span><span class="o">-</span><span class="mi">565</span><span class="n">dfc7d75</span><span class="o">-</span><span class="mi">78</span><span class="n">ql9</span><span class="p">:</span><span class="mi">53</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="p">:</span><span class="mi">8648</span><span class="p">)</span><span class="w"> </span><span class="n">policy</span><span class="o">-</span><span class="n">verdict</span><span class="p">:</span><span class="n">all</span><span class="w"> </span><span class="n">INGRESS</span><span class="w"> </span><span class="n">ALLOWED</span><span class="w"> </span><span class="p">(</span><span class="n">UDP</span><span class="p">)</span>
<span class="n">Jan</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="mi">09</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mf">09.440</span><span class="p">:</span><span class="w"> </span><span class="n">default</span><span class="o">/</span><span class="n">kienlt</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">tools</span><span class="p">:</span><span class="mi">54729</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="p">:</span><span class="mi">46060</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">kube</span><span class="o">-</span><span class="n">system</span><span class="o">/</span><span class="n">rke2</span><span class="o">-</span><span class="n">coredns</span><span class="o">-</span><span class="n">rke2</span><span class="o">-</span><span class="n">coredns</span><span class="o">-</span><span class="mi">565</span><span class="n">dfc7d75</span><span class="o">-</span><span class="mi">78</span><span class="n">ql9</span><span class="p">:</span><span class="mi">53</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="p">:</span><span class="mi">8648</span><span class="p">)</span><span class="w"> </span><span class="n">to</span><span class="o">-</span><span class="n">endpoint</span><span class="w"> </span><span class="n">FORWARDED</span><span class="w"> </span><span class="p">(</span><span class="n">UDP</span><span class="p">)</span>
<span class="n">Jan</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="mi">09</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mf">09.440</span><span class="p">:</span><span class="w"> </span><span class="n">default</span><span class="o">/</span><span class="n">kienlt</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">tools</span><span class="p">:</span><span class="mi">54729</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="p">:</span><span class="mi">46060</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">kube</span><span class="o">-</span><span class="n">system</span><span class="o">/</span><span class="n">rke2</span><span class="o">-</span><span class="n">coredns</span><span class="o">-</span><span class="n">rke2</span><span class="o">-</span><span class="n">coredns</span><span class="o">-</span><span class="mi">565</span><span class="n">dfc7d75</span><span class="o">-</span><span class="mi">78</span><span class="n">ql9</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="p">:</span><span class="mi">8648</span><span class="p">)</span><span class="w"> </span><span class="n">pre</span><span class="o">-</span><span class="n">xlate</span><span class="o">-</span><span class="n">rev</span><span class="w"> </span><span class="n">TRACED</span><span class="w"> </span><span class="p">(</span><span class="n">UDP</span><span class="p">)</span>
<span class="n">Jan</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="mi">09</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mf">09.440</span><span class="p">:</span><span class="w"> </span><span class="n">default</span><span class="o">/</span><span class="n">kienlt</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">tools</span><span class="p">:</span><span class="mi">54729</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="p">:</span><span class="mi">46060</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">kube</span><span class="o">-</span><span class="n">system</span><span class="o">/</span><span class="n">rke2</span><span class="o">-</span><span class="n">coredns</span><span class="o">-</span><span class="n">rke2</span><span class="o">-</span><span class="n">coredns</span><span class="o">-</span><span class="mi">565</span><span class="n">dfc7d75</span><span class="o">-</span><span class="mi">78</span><span class="n">ql9</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="p">:</span><span class="mi">8648</span><span class="p">)</span><span class="w"> </span><span class="n">pre</span><span class="o">-</span><span class="n">xlate</span><span class="o">-</span><span class="n">rev</span><span class="w"> </span><span class="n">TRACED</span><span class="w"> </span><span class="p">(</span><span class="n">UDP</span><span class="p">)</span>
</code></pre></div>

<h1>Cilium Network policies</h1>
<h3>Comparison</h3>
<ul>
<li><strong>Kubernetes Network Policies</strong>: Kubernetes network policies are used to control the traffic between pods. They are defined using the NetworkPolicy resource.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">allow-nginx</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">podSelector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">  </span><span class="nt">policyTypes</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Egress</span>
<span class="w">  </span><span class="nt">ingress</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">from</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">podSelector</span><span class="p">:</span>
<span class="w">        </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">frontend</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">  </span><span class="nt">egress</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">to</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">podSelector</span><span class="p">:</span>
<span class="w">        </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backend</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</code></pre></div>

<ul>
<li><strong>Cilium Network Policies</strong>: Cilium extends the capabilities of Kubernetes network policies by leveraging eBPF. Cilium policies can be more expressive and can include L7 (Layer 7) rules.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cilium.io/v2</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CiliumNetworkPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">allow-nginx</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">endpointSelector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">  </span><span class="nt">ingress</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">fromEndpoints</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">frontend</span>
<span class="w">    </span><span class="nt">toPorts</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;80&quot;</span>
<span class="w">        </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class="w">  </span><span class="nt">egress</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">toEndpoints</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backend</span>
<span class="w">    </span><span class="nt">toPorts</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;8080&quot;</span>
<span class="w">        </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">toServices</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">k8sService</span><span class="p">:</span>
<span class="w">        </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">        </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">external-service</span>
<span class="w">  </span><span class="nt">l7Rules</span><span class="p">:</span>
<span class="w">    </span><span class="nt">http</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">method</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GET</span>
<span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/api&quot;</span>
</code></pre></div>

<p>The above is just an example xD, and CiliumNetworkPolicy may not work because i copied somewhere for the content. For a real example, let's continue to read below xDD.</p>
<ul>
<li><strong>Key Differences</strong>:<ul>
<li>Layer 7 Policies: Cilium supports L7 policies (e.g., HTTP methods and paths), while Kubernetes network policies are limited to L3/L4 (IP and port).</li>
<li>Integration with eBPF: Cilium uses eBPF for efficient packet processing, which can provide better performance and more advanced features.</li>
</ul>
</li>
</ul>
<h3>A real example of Cilium Network policies</h3>
<ul>
<li>Before I'm able to write this, i wasted 3-4 hours for checking and testing why we can't have rules that allow both allow/deny. Simply it doesn't support &gt;.&gt;</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nv">Cilium</span><span class="w"> </span><span class="nv">L7</span><span class="w"> </span><span class="nv">policies</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="nv">not</span><span class="w"> </span><span class="nv">directly</span><span class="w"> </span><span class="nv">support</span><span class="w"> </span><span class="nv">explicit</span><span class="w"> </span><span class="nv">deny</span><span class="w"> </span><span class="nv">rules</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">specific</span><span class="w"> </span><span class="nv">HTTP</span><span class="w"> </span><span class="nv">paths</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">methods</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">moment</span>.<span class="w"> </span><span class="nv">Instead</span>,<span class="w"> </span><span class="nv">they</span><span class="w"> </span><span class="nv">operate</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">an</span><span class="w"> </span><span class="nv">allowlist</span><span class="o">-</span><span class="nv">only</span><span class="w"> </span><span class="nv">model</span>,<span class="w"> </span><span class="nv">meaning</span>:

<span class="mi">1</span>.<span class="w"> </span><span class="nv">Any</span><span class="w"> </span><span class="nv">traffic</span><span class="w"> </span><span class="nv">explicitly</span><span class="w"> </span><span class="nv">defined</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">rules</span>.<span class="nv">l7</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">allowed</span>.
<span class="mi">2</span>.<span class="w"> </span><span class="nv">Any</span><span class="w"> </span><span class="nv">traffic</span><span class="w"> </span><span class="nv">not</span><span class="w"> </span><span class="nv">explicitly</span><span class="w"> </span><span class="nv">listed</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">denied</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="nv">default</span>.

<span class="nv">This</span><span class="w"> </span><span class="nv">can</span><span class="w"> </span><span class="nv">feel</span><span class="w"> </span><span class="nv">limiting</span><span class="w"> </span><span class="nv">when</span><span class="w"> </span><span class="nv">you</span><span class="err">&#39;re looking for explicit deny functionality. However, there are ways to handle this situation effectively depending on your use case.</span>
</code></pre></div>

<ul>
<li><strong>Real Example</strong>: Rule that allows access only path /employees from namespace <code>test</code> to namespace <code>python-app</code></li>
</ul>
<div class="highlight"><pre><span></span><code>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;python-app&quot;
  namespace: &quot;python-app&quot;
  # Apply this in the namespace you want to protect
spec:
  # Target all pods in the namespace where this policy is applied
  endpointSelector: {} # Apply this policy to all pods in the python-app namespace
  ingress:
  # Allow all traffic from pods in test namespace
  <span class="k">-</span> fromEndpoints:
    <span class="k">-</span> matchLabels:
        # This matches all pods in the test namespace
        k8s:io.kubernetes.pod.namespace: test
    toPorts:
      <span class="k">-</span> ports:
        <span class="k">-</span> port: &quot;5000&quot;
          protocol: TCP
        rules:
          http:
          <span class="k">-</span> method: &quot;GET&quot;
            path: &quot;/employees.*&quot;
</code></pre></div>

<ul>
<li>Lets go for testing, if the path is simple <strong>path: "/employees"</strong>. The request to <strong>python-api-app-production.python-app.svc:5000/employees/1</strong> will be denied!</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">### Access from namespace test</span>
<span class="n">k</span><span class="w"> </span><span class="n">exec</span><span class="w"> </span><span class="o">-</span><span class="n">n</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">kienlt</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">tools</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="s2">&quot;python-api-app-production.python-app.svc:5000/employees&quot;</span>
<span class="p">[{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Ashley&quot;</span><span class="p">},{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Kate&quot;</span><span class="p">},{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Joe&quot;</span><span class="p">}]</span>

<span class="n">k</span><span class="w"> </span><span class="n">exec</span><span class="w"> </span><span class="o">-</span><span class="n">n</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">kienlt</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">tools</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="s2">&quot;python-api-app-production.python-app.svc:5000/secret&quot;</span>
<span class="n">Access</span><span class="w"> </span><span class="n">denied</span>

<span class="n">k</span><span class="w"> </span><span class="n">exec</span><span class="w"> </span><span class="o">-</span><span class="n">n</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">kienlt</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">tools</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="s2">&quot;python-api-app-production.python-app.svc:5000/&quot;</span>
<span class="n">Access</span><span class="w"> </span><span class="n">denied</span>

<span class="n">k</span><span class="w"> </span><span class="n">exec</span><span class="w"> </span><span class="o">-</span><span class="n">n</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">kienlt</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">tools</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="s2">&quot;python-api-app-production.python-app.svc:5000/employees/1&quot;</span>
<span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Ashley&quot;</span><span class="p">}</span>
<span class="c1">### Access from namespace default</span>
<span class="n">k</span><span class="w"> </span><span class="n">exec</span><span class="w"> </span><span class="n">kienlt</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">tools</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">nc</span><span class="w"> </span><span class="o">-</span><span class="n">w</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">-</span><span class="n">vz</span><span class="w"> </span><span class="n">python</span><span class="o">-</span><span class="n">api</span><span class="o">-</span><span class="n">app</span><span class="o">-</span><span class="n">production</span><span class="o">.</span><span class="n">python</span><span class="o">-</span><span class="n">app</span><span class="o">.</span><span class="n">svc</span><span class="w"> </span><span class="mi">5000</span>
<span class="n">nc</span><span class="p">:</span><span class="w"> </span><span class="n">python</span><span class="o">-</span><span class="n">api</span><span class="o">-</span><span class="n">app</span><span class="o">-</span><span class="n">production</span><span class="o">.</span><span class="n">python</span><span class="o">-</span><span class="n">app</span><span class="o">.</span><span class="n">svc</span><span class="w"> </span><span class="p">(</span><span class="mf">10.43</span><span class="o">.</span><span class="mf">67.70</span><span class="p">:</span><span class="mi">5000</span><span class="p">):</span><span class="w"> </span><span class="n">Operation</span><span class="w"> </span><span class="n">timed</span><span class="w"> </span><span class="n">out</span>
<span class="n">command</span><span class="w"> </span><span class="n">terminated</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">exit</span><span class="w"> </span><span class="n">code</span><span class="w"> </span>
</code></pre></div>

<p>Specials thanks to <code>isovalent.com</code> for the tutorials xD ( included reference link below)</p>
<h1>Conclusion</h1>
<ul>
<li>I had a little hard time understanding, but in the end, mostly i got it at some percent xD.</li>
<li>K8S is complicated, understand a small part will lead to a bigger part. Just don't give up, keep going!</li>
<li>Learning with ChatGPT and Copilot is faster than doing research with only yourself!</li>
</ul>
<h1>Reference:</h1>
<ul>
<li><a href="https://ranchermanager.docs.rancher.com/">https://ranchermanager.docs.rancher.com/</a></li>
<li><a href="https://docs.cilium.io/en/stable/overview/intro/">https://docs.cilium.io/en/stable/overview/intro/</a></li>
<li><a href="https://cilium.io/blog/2018/04/17/why-is-the-kernel-community-replacing-iptables/">https://cilium.io/blog/2018/04/17/why-is-the-kernel-community-replacing-iptables/</a></li>
<li><a href="https://archive.fosdem.org/2020/schedule/event/replacing_iptables_with_ebpf/attachments/slides/3622/export/events/attachments/replacing_iptables_with_ebpf/slides/3622/Cilium_FOSDEM_2020.pdf">replacing_iptables_with_ebpf</a></li>
<li><a href="https://isovalent.com/blog/post/tutorial-cilium-network-policy/">https://isovalent.com/blog/post/tutorial-cilium-network-policy/</a></li>
</ul>


             
 
            
            
            







            <hr/>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2025-01-20T00:00:00+07:00">Mon 20 January 2025</time>
            <h4>Category</h4>
            <a class="category-link" href="/categories.html#knowledge-base-ref">Knowledge Base</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="/tags.html#k8s-ref">k8s
                    <span class="superscript">6</span>
</a></li>
            </ul>
<h4>Contact</h4>
<div id="sidebar-social-link">
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="/theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>