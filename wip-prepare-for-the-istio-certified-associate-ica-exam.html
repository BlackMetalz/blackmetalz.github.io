<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="https://blackmetalz.github.io/theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://blackmetalz.github.io/theme/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="author" content="kienlt" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="istio, certification, linux-foundation, ica, service-mesh, Knowledge Base, " />

<meta property="og:title" content="[WIP] Prepare for the Istio Certified Associate (ICA) Exam "/>
<meta property="og:url" content="https://blackmetalz.github.io/wip-prepare-for-the-istio-certified-associate-ica-exam.html" />
<meta property="og:description" content="" />
<meta property="og:site_name" content="Kienlt&#39;s notebook" />
<meta property="og:article:author" content="kienlt" />
<meta property="og:article:published_time" content="2025-12-31T00:00:00+07:00" />
<meta name="twitter:title" content="[WIP] Prepare for the Istio Certified Associate (ICA) Exam ">
<meta name="twitter:description" content="">

        <title>[WIP] Prepare for the Istio Certified Associate (ICA) Exam  · Kienlt&#39;s notebook
</title>
        <link href="https://blackmetalz.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Kienlt&#39;s notebook - Full Atom Feed" />



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="https://blackmetalz.github.io/"><span class=site-name>Kienlt's notebook</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       https://blackmetalz.github.io
                                    >Home</a>
                                </li>
                                <li ><a href="https://blackmetalz.github.io/categories.html">Categories</a></li>
                                <li ><a href="https://blackmetalz.github.io/tags.html">Tags</a></li>
                                <li ><a href="https://blackmetalz.github.io/archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="https://blackmetalz.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="https://blackmetalz.github.io/wip-prepare-for-the-istio-certified-associate-ica-exam.html">
                [WIP] Prepare for the Istio Certified Associate (ICA) Exam
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <p><img alt="alt text" src="images/2025/12/20.png"></p>
<hr>
<h1>Istio Certified Associate (ICA) Overview</h1>
<h3>1. Service Mesh Fundamentals</h3>
<p>Understanding the "Why" before the "How."</p>
<ul>
<li><strong>What is a Service Mesh:</strong> A dedicated infrastructure layer for managing service-to-service communication in microservices architectures.</li>
<li><strong>The Need for Istio:</strong> Solving challenges like traffic management, security, and observability without modifying application code.</li>
<li><strong>Sidecar vs. Ambient Mode:</strong> Understanding the two deployment models — Sidecar (Envoy proxy per pod) vs. Ambient (ztunnel + waypoint proxies).</li>
</ul>
<h3>2. Istio Core Architecture</h3>
<p>The backbone of the service mesh.</p>
<ul>
<li><strong>Control Plane (istiod):</strong> The brain of Istio — handles configuration, certificate management, and service discovery.</li>
<li><strong>Data Plane:</strong> Envoy proxies that intercept and manage all network traffic between services.</li>
<li><strong>Key Components:</strong> All consolidated into <code>istiod</code> — handles traffic management (formerly Pilot), security/mTLS (formerly Citadel), and configuration validation (formerly Galley).</li>
</ul>
<p>Example of <strong>Traffic Flow</strong>:</p>
<p><img alt="alt text" src="images/2025/12/36.png"></p>
<h3>3. Installation, Upgrade &amp; Configuration (20%)</h3>
<p>Getting Istio up and running.</p>
<ul>
<li><strong>Installation Methods:</strong> Using <code>istioctl install</code> or Helm charts.</li>
<li><strong>Installation Profiles:</strong> Understanding <code>default</code>, <code>demo</code>, <code>minimal</code>, and <code>ambient</code> profiles.</li>
<li><strong>Customizing Installation:</strong> Using IstioOperator resource for advanced configurations.</li>
<li><strong>Upgrade Strategies:</strong> Canary upgrades (run two control planes) vs. In-place upgrades.</li>
</ul>
<h3>4. Traffic Management (35%)</h3>
<p>The largest exam domain — master this well.</p>
<ul>
<li><strong>Ingress &amp; Egress:</strong> Configuring Gateway resources for north-south traffic. (North-South = traffic comes from external)</li>
<li><strong>VirtualService:</strong> Defining routing rules (host-based, header-based, URI matching).</li>
<li><strong>DestinationRule:</strong> Configuring load balancing policies, connection pools, and outlier detection.</li>
<li><strong>Traffic Shifting:</strong> Canary deployments and A/B testing with weighted routing.</li>
<li><strong>Resilience Features:</strong> Circuit breaking, retries, timeouts, and failover.</li>
<li><strong>Fault Injection:</strong> Testing resilience by injecting delays or HTTP errors.</li>
<li><strong>ServiceEntry:</strong> Connecting in-mesh workloads to external services.</li>
</ul>
<h3>5. Securing Workloads (25%)</h3>
<p>Zero-trust security model.</p>
<ul>
<li><strong>Mutual TLS (mTLS):</strong> Automatic encryption between services using PeerAuthentication.</li>
<li><strong>Authorization Policies:</strong> Fine-grained access control (allow/deny based on source, operation, conditions).</li>
<li><strong>RequestAuthentication:</strong> Validating JWT tokens at the mesh edge.</li>
<li><strong>Securing Edge Traffic:</strong> Configuring TLS termination and passthrough at the Ingress Gateway.</li>
</ul>
<h3>6. Troubleshooting (20%)</h3>
<p>Debugging when things go wrong.</p>
<ul>
<li><strong>Configuration Issues:</strong> Using <code>istioctl analyze</code> to detect misconfigurations.</li>
<li><strong>Control Plane Debugging:</strong> Checking istiod logs, sync status, and xDS (x Discovery Service) configuration. </li>
<li><strong>Data Plane Debugging:</strong> Using <code>istioctl proxy-status</code>, <code>proxy-config</code>, and Envoy admin interface.</li>
<li><strong>Common Issues:</strong> 503 errors, mTLS conflicts, missing sidecars, and routing mismatches.</li>
</ul>
<hr>
<h1>Sections That Need to Be Understood</h1>
<h3>1. Sidecar vs. Ambient Mode</h3>
<p><em>Domain: Installation, Upgrade &amp; Configuration</em></p>
<p>Istio offers two data plane modes. Understanding the differences is crucial for the exam.</p>
<p><strong>Sidecar Mode (Traditional):</strong></p>
<p><img alt="alt text" src="images/2025/12/37.png"></p>
<ul>
<li>Every pod gets its own Envoy proxy injected as a sidecar container.</li>
<li><strong>Pros:</strong> Full L7 features, mature and battle-tested.</li>
<li><strong>Cons:</strong> High resource overhead (memory/CPU per pod), increased latency.</li>
</ul>
<p><strong>Ambient Mode (Sidecar-less):</strong></p>
<p><img alt="alt text" src="images/2025/12/38.png"></p>
<ul>
<li><strong>ztunnel:</strong> Node-level proxy handling L4 (TCP, mTLS).</li>
<li><strong>Waypoint Proxy:</strong> Optional L7 proxy deployed per namespace or service.</li>
<li><strong>Pros:</strong> Lower resource usage, simpler operations, no sidecar injection needed.</li>
<li><strong>Cons:</strong> Newer, some L7 features require waypoint deployment.</li>
</ul>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Sidecar Mode</th>
<th>Ambient Mode</th>
</tr>
</thead>
<tbody>
<tr>
<td>Resource overhead</td>
<td>High (per pod)</td>
<td>Low (per node)</td>
</tr>
<tr>
<td>L4 mTLS</td>
<td>Supported</td>
<td>Supported (ztunnel)</td>
</tr>
<tr>
<td>L7 features</td>
<td>Support (always)</td>
<td>Support (needs waypoint)</td>
</tr>
<tr>
<td>Injection required</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>Maturity</td>
<td>Stable</td>
<td>Newer (GA in 1.24+)</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>References:</strong></p>
<ul>
<li><a href="https://istio.io/latest/docs/ambient/">Istio Ambient Mode</a></li>
<li><a href="https://istio.io/latest/docs/overview/dataplane-modes/">Sidecar vs Ambient Comparison</a></li>
</ul>
</blockquote>
<hr>
<h3>2. VirtualService &amp; DestinationRule Relationship</h3>
<p><em>Domain: Traffic Management</em></p>
<p>These two resources work together and are the <strong>most important concepts</strong> for the exam.</p>
<p>TLDR: This may be complicated for you to understand (same for me). But no worry, just read the fucking document and practice here, it is fucking best lab based in my opinion to explain how Virtual Service and Destination Rule work together!</p>
<p><a href="https://killercoda.com/lorenzo-g/scenario/traffic-management-request-routing">KillerCoda ICA - Traffic Management - Request Routing</a></p>
<p>It could be a little outdated, but still good to practice</p>
<div class="highlight"><pre><span></span><code>controlplane:~$ istioctl version
client version: 1.18.2
control plane version: 1.18.2
data plane version: 1.18.2 (3 proxies)
</code></pre></div>

<p>So you have to change apiVersion from <code>networking.istio.io/v1</code> to <code>networking.istio.io/v1alpha3</code> to prevent issue in that scenario!</p>
<p><strong>Resource Relationship:</strong></p>
<p><img alt="alt text" src="images/2025/12/39.png"></p>
<p>Can be retrieved with: <code>k get vs</code></p>
<div class="highlight"><pre><span></span><code>controlplane:~$<span class="w"> </span>k<span class="w"> </span>api-resources<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span>-i<span class="w"> </span>virtual
virtualservices<span class="w">                     </span>vs<span class="w">           </span>networking.istio.io/v1beta1<span class="w">       </span><span class="nb">true</span><span class="w">         </span>VirtualService
</code></pre></div>

<p><strong>VirtualService — Defines WHERE traffic goes:</strong> This may complicate as hell, try to start simple with hosts and http route + destination!</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VirtualService</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews-routing</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span><span class="w">                          </span><span class="c1"># Target service / Kubernetes Service Name!</span>
<span class="w">  </span><span class="nt">gateways</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mesh</span><span class="w">                             </span><span class="c1"># For internal mesh traffic</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bookinfo-gateway</span><span class="w">                 </span><span class="c1"># For external traffic</span>
<span class="w">  </span><span class="nt">http</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">headers</span><span class="p">:</span>
<span class="w">            </span><span class="nt">end-user</span><span class="p">:</span>
<span class="w">              </span><span class="nt">exact</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jason</span><span class="w">             </span><span class="c1"># Header-based routing</span>
<span class="w">      </span><span class="nt">route</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">destination</span><span class="p">:</span>
<span class="w">            </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="w">            </span><span class="nt">subset</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v2</span><span class="w">                 </span><span class="c1"># Route to v2 for user &quot;jason&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">route</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">destination</span><span class="p">:</span>
<span class="w">            </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="w">            </span><span class="nt">subset</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="w">          </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span><span class="w">                   </span><span class="c1"># 80% to v1</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">destination</span><span class="p">:</span>
<span class="w">            </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="w">            </span><span class="nt">subset</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v3</span>
<span class="w">          </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20</span><span class="w">                   </span><span class="c1"># 20% to v3</span>
</code></pre></div>

<p><strong>DestinationRule — Defines HOW traffic is handled:</strong> This is also fucking complicated, try to simplify as <code>kind: DestinationRule</code> in <a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/">HERE</a></p>
<p>Can be retrieved with: <code>k get dr</code></p>
<div class="highlight"><pre><span></span><code>controlplane:~$<span class="w"> </span>k<span class="w"> </span>api-resources<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span>-i<span class="w"> </span>dest<span class="w">   </span>
destinationrules<span class="w">                    </span>dr<span class="w">           </span>networking.istio.io/v1beta1<span class="w">       </span><span class="nb">true</span><span class="w">         </span>DestinationRule
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DestinationRule</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews-destination</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span><span class="w">                        </span><span class="c1"># Must match VirtualService destination</span>
<span class="w">  </span><span class="nt">trafficPolicy</span><span class="p">:</span>
<span class="w">    </span><span class="nt">connectionPool</span><span class="p">:</span>
<span class="w">      </span><span class="nt">tcp</span><span class="p">:</span>
<span class="w">        </span><span class="nt">maxConnections</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="w">      </span><span class="nt">http</span><span class="p">:</span>
<span class="w">        </span><span class="nt">h2UpgradePolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">UPGRADE</span>
<span class="w">        </span><span class="nt">http1MaxPendingRequests</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="w">    </span><span class="nt">loadBalancer</span><span class="p">:</span>
<span class="w">      </span><span class="nt">simple</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ROUND_ROBIN</span><span class="w">              </span><span class="c1"># ROUND_ROBIN, LEAST_CONN, RANDOM, PASSTHROUGH</span>
<span class="w">    </span><span class="nt">outlierDetection</span><span class="p">:</span>
<span class="w">      </span><span class="nt">consecutive5xxErrors</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="w">      </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span>
<span class="w">      </span><span class="nt">baseEjectionTime</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>
<span class="w">  </span><span class="nt">subsets</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w">                    </span><span class="c1"># Pod selector</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v2</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v2</span>
<span class="w">      </span><span class="nt">trafficPolicy</span><span class="p">:</span><span class="w">                   </span><span class="c1"># Subset-specific policy</span>
<span class="w">        </span><span class="nt">loadBalancer</span><span class="p">:</span>
<span class="w">          </span><span class="nt">simple</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LEAST_CONN</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v3</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v3</span>
</code></pre></div>

<p><strong>Summary</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># DestinationRule define subset</span>
<span class="nt">subsets</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>

<span class="c1"># VirtualService route to that subset </span>
<span class="nt">route</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">destination</span><span class="p">:</span>
<span class="w">    </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-svc</span>
<span class="w">    </span><span class="nt">subset</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w">  </span><span class="c1"># refer to DestinationRule</span>
</code></pre></div>

<p><code>VirtualService</code> and <code>DestinationRule</code> are namespace-scoped. But can be reference cross-namespace by FQDN <code>my-svc.other-namespace.svc.cluster.local</code> in <code>host</code> field!</p>
<p>Extra note: <strong>Order matters!</strong> </p>
<p>With this VirtualService, subset v2 will be ignored. Because Istio is working with the rule: <code>First Match Wins.</code></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1alpha3</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VirtualService</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">notification</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">notification-service.default.svc.cluster.local</span>
<span class="w">  </span><span class="nt">http</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">route</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">destination</span><span class="p">:</span>
<span class="w">          </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">notification-service.default.svc.cluster.local</span>
<span class="w">          </span><span class="nt">subset</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">route</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">destination</span><span class="p">:</span>
<span class="w">          </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">notification-service.default.svc.cluster.local</span>
<span class="w">          </span><span class="nt">subset</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v2</span>
<span class="w">      </span><span class="nt">match</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">headers</span><span class="p">:</span>
<span class="w">          </span><span class="nt">testing</span><span class="p">:</span>
<span class="w">            </span><span class="nt">exact</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
</code></pre></div>

<p>So we have to move subset v2 to be the first entry, then follow with subset v1!</p>
<p>Another thing you should notice, that both resource VirtualService and DestinationRule have to define hosts? Why not merge them???</p>
<p>It is <code>Separation of Concerns</code> of Istio.</p>
<ul>
<li><code>VirtualService</code> is router for traffic filter, where the fuck you want to go?</li>
<li><code>DestinationRule</code> is policy, traffic have been arrived, how would you act?</li>
</ul>
<p>So, in explanation of SQL. <code>hosts</code> is <code>Foreign Key</code> to match table <code>VirtualService</code> to table <code>DestinationRule</code> xD</p>
<p>Conclusion: It took me about 2 hours to understand this properly!</p>
<blockquote>
<p><strong>Key Point:</strong> VirtualService references subsets defined in DestinationRule. Always create DestinationRule <strong>before</strong> or <strong>together with</strong> VirtualService.</p>
<p><strong>References:</strong></p>
<ul>
<li><a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/">VirtualService</a></li>
<li><a href="https://istio.io/latest/docs/reference/config/networking/destination-rule/">DestinationRule</a></li>
</ul>
</blockquote>
<hr>
<h3>3. Gateway Configuration</h3>
<p><em>Domain: Traffic Management</em></p>
<p>Gateway defines the entry/exit points for traffic entering or leaving the mesh.</p>
<p>You may want to know where <code>istio: ingressgateway</code> in the selector field comes from xD</p>
<div class="highlight"><pre><span></span><code>controlplane:~$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-A<span class="w"> </span>-l<span class="w"> </span><span class="nv">istio</span><span class="o">=</span>ingressgateway
NAMESPACE<span class="w">      </span>NAME<span class="w">                                    </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
istio-system<span class="w">   </span>istio-ingressgateway-78dcb6c4fb-72j69<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>4m22s
</code></pre></div>

<p><strong>Ingress Gateway (North-South Traffic IN):</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Gateway</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bookinfo-gateway</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">istio</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ingressgateway</span><span class="w">              </span><span class="c1"># Use Istio&#39;s default ingress gateway. </span>
<span class="w">  </span><span class="nt">servers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span>
<span class="w">        </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<span class="w">        </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HTTP</span>
<span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bookinfo.example.com&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span>
<span class="w">        </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https</span>
<span class="w">        </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HTTPS</span>
<span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bookinfo.example.com&quot;</span>
<span class="w">      </span><span class="nt">tls</span><span class="p">:</span>
<span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SIMPLE</span><span class="w">                   </span><span class="c1"># TLS termination</span>
<span class="w">        </span><span class="nt">credentialName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bookinfo-cert</span><span class="w">  </span><span class="c1"># K8s secret with TLS cert</span>
</code></pre></div>

<p><strong>TLS Modes:</strong></p>
<table>
<thead>
<tr>
<th>Mode</th>
<th>Description</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SIMPLE</code></td>
<td>TLS termination at gateway</td>
<td>Standard HTTPS</td>
</tr>
<tr>
<td><code>MUTUAL</code></td>
<td>mTLS - client cert required</td>
<td>High security, need correct keys: <code>tls.crt tls.key ca.crt</code></td>
</tr>
<tr>
<td><code>PASSTHROUGH</code></td>
<td>TLS passed to backend</td>
<td>Backend handles TLS</td>
</tr>
<tr>
<td><code>ISTIO_MUTUAL</code></td>
<td>Istio mTLS</td>
<td>Internal mesh traffic</td>
</tr>
</tbody>
</table>
<p><strong>Connect Gateway to VirtualService:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VirtualService</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bookinfo-vs</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bookinfo.example.com&quot;</span>
<span class="w">  </span><span class="nt">gateways</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bookinfo-gateway</span><span class="w">                 </span><span class="c1"># Reference the Gateway</span>
<span class="w">  </span><span class="nt">http</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">route</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">destination</span><span class="p">:</span>
<span class="w">            </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">productpage</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9080</span>
</code></pre></div>

<p>Small reminder for you and for me, if you have been learning in Cilium or K8S modern technical Gateway API. You will notice and ask if they are the same?</p>
<p>In fact, they are the same for concept, they are all config, they need a real proxy (Envoy/Cilium/Nginx) behind to handle traffic. Here is a little comparison:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Component</th>
<th style="text-align: left;">K8s Gateway API</th>
<th style="text-align: left;">Istio Gateway</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Listener</strong></td>
<td style="text-align: left;">Gateway</td>
<td style="text-align: left;">Gateway (included host, TLS)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Routing</strong></td>
<td style="text-align: left;">HTTPRoute</td>
<td style="text-align: left;">VirtualService</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Selector</strong></td>
<td style="text-align: left;"><code>gatewayClassName</code></td>
<td style="text-align: left;"><code>selector: istio: ingressgateway</code></td>
</tr>
</tbody>
</table>
<p><strong>Egress Gateway (North-South Traffic OUT):</strong> Just need to memorize syntax, I will have a section explain this below with <code>ServiceEntry</code> and <code>VirtualService</code> with Egress Gateway together to see how it works!</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Gateway</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">istio-egressgateway</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">istio</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">egressgateway</span>
<span class="w">  </span><span class="nt">servers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span>
<span class="w">        </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls</span>
<span class="w">        </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TLS</span>
<span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;external-api.example.com&quot;</span>
<span class="w">      </span><span class="nt">tls</span><span class="p">:</span>
<span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PASSTHROUGH</span>
</code></pre></div>

<blockquote>
<p><strong>References:</strong></p>
<ul>
<li><a href="https://istio.io/latest/docs/reference/config/networking/gateway/">Istio Gateway</a></li>
<li><a href="https://istio.io/latest/docs/tasks/traffic-management/ingress/">Ingress Gateway</a></li>
</ul>
</blockquote>
<hr>
<h3>4. Traffic Shifting &amp; Canary Deployments</h3>
<p><em>Domain: Traffic Management</em></p>
<p>Gradually shift traffic between service versions for safe deployments.</p>
<p><strong>Weighted Routing (Canary):</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VirtualService</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="w">  </span><span class="nt">http</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">route</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">destination</span><span class="p">:</span>
<span class="w">            </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="w">            </span><span class="nt">subset</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="w">          </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">90</span><span class="w">                   </span><span class="c1"># 90% to stable version</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">destination</span><span class="p">:</span>
<span class="w">            </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="w">            </span><span class="nt">subset</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v2</span>
<span class="w">          </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w">                   </span><span class="c1"># 10% to canary version</span>
</code></pre></div>

<p><strong>Header-Based Routing (A/B Testing):</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VirtualService</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="w">  </span><span class="nt">http</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">headers</span><span class="p">:</span>
<span class="w">            </span><span class="nt">x-canary</span><span class="p">:</span>
<span class="w">              </span><span class="nt">exact</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="w">            </span><span class="c1"># Route if header present</span>
<span class="w">      </span><span class="nt">route</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">destination</span><span class="p">:</span>
<span class="w">            </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="w">            </span><span class="nt">subset</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v2</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">route</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">destination</span><span class="p">:</span>
<span class="w">            </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="w">            </span><span class="nt">subset</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w">                 </span><span class="c1"># Default route</span>
</code></pre></div>

<p><strong>Traffic Mirroring (Shadow Traffic):</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VirtualService</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="w">  </span><span class="nt">http</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">route</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">destination</span><span class="p">:</span>
<span class="w">            </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="w">            </span><span class="nt">subset</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="w">      </span><span class="nt">mirror</span><span class="p">:</span>
<span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="w">        </span><span class="nt">subset</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v2</span><span class="w">                     </span><span class="c1"># Mirror traffic to v2</span>
<span class="w">      </span><span class="nt">mirrorPercentage</span><span class="p">:</span>
<span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100.0</span><span class="w">                   </span><span class="c1"># Mirror 100% of traffic</span>
</code></pre></div>

<blockquote>
<p><strong>Key Point:</strong> Mirrored traffic is "fire and forget" — responses from the mirror are discarded.</p>
<p><strong>References:</strong></p>
<ul>
<li><a href="https://istio.io/latest/docs/tasks/traffic-management/traffic-shifting/">Traffic Shifting</a></li>
<li><a href="https://istio.io/latest/docs/tasks/traffic-management/mirroring/">Mirroring</a></li>
</ul>
</blockquote>
<hr>
<h3>5. mTLS &amp; PeerAuthentication</h3>
<p><em>Domain: Securing Workloads</em></p>
<p>Istio can automatically encrypt all service-to-service traffic using mutual TLS.</p>
<p><strong>PeerAuthentication Modes:</strong></p>
<table>
<thead>
<tr>
<th>Mode</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>STRICT</code></td>
<td>Only mTLS traffic allowed (reject plaintext)</td>
</tr>
<tr>
<td><code>PERMISSIVE</code></td>
<td>Accept both mTLS and plaintext (migration mode)</td>
</tr>
<tr>
<td><code>DISABLE</code></td>
<td>Disable mTLS</td>
</tr>
<tr>
<td><code>UNSET</code></td>
<td>Inherit from parent scope</td>
</tr>
</tbody>
</table>
<p><strong>Scope Hierarchy:</strong></p>
<p><img alt="alt text" src="images/2025/12/40.png"></p>
<p><strong>Mesh-wide STRICT mTLS:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">security.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PeerAuthentication</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">istio-system</span><span class="w">              </span><span class="c1"># istio-system = mesh-wide</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">mtls</span><span class="p">:</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">STRICT</span>
</code></pre></div>

<p><strong>Namespace-level mTLS:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">security.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PeerAuthentication</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span><span class="w">                </span><span class="c1"># Applies to production namespace</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">mtls</span><span class="p">:</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">STRICT</span>
</code></pre></div>

<p><strong>Workload-level mTLS:</strong> The guard decides to accept or reject traffic. With STRICT, it said: I only accept TLS, plaintext will get rejected! Not related to anything client-side!</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">security.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PeerAuthentication</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews-mtls</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span><span class="w">                     </span><span class="c1"># Only applies to reviews service</span>
<span class="w">  </span><span class="nt">mtls</span><span class="p">:</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">STRICT</span><span class="w">                       </span><span class="c1"># All port requires mTLS</span>
<span class="w">  </span><span class="nt">portLevelMtls</span><span class="p">:</span>
<span class="w">    </span><span class="nt">8080</span><span class="p">:</span>
<span class="w">      </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PERMISSIVE</span><span class="w">                 </span><span class="c1"># Port-specific override that allow both mTLS and plaintext</span>
</code></pre></div>

<p><strong>DestinationRule TLS Settings (Client-side):</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DestinationRule</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews-mtls</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="w">  </span><span class="nt">trafficPolicy</span><span class="p">:</span>
<span class="w">    </span><span class="nt">tls</span><span class="p">:</span>
<span class="w">      </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ISTIO_MUTUAL</span><span class="w">               </span><span class="c1"># Use Istio&#39;s mTLS</span>
</code></pre></div>

<blockquote>
<p><strong>Key Point:</strong> PeerAuthentication = server-side (what traffic to accept). DestinationRule tls = client-side (how to connect).</p>
<p><strong>References:</strong></p>
<ul>
<li><a href="https://istio.io/latest/docs/reference/config/security/peer_authentication/">PeerAuthentication</a></li>
<li><a href="https://istio.io/latest/docs/tasks/security/authentication/mtls-migration/">Mutual TLS Migration</a></li>
</ul>
</blockquote>
<hr>
<h3>6. AuthorizationPolicy</h3>
<p><em>Domain: Securing Workloads</em></p>
<p>Fine-grained access control for workloads.</p>
<p><strong>Policy Actions:</strong></p>
<table>
<thead>
<tr>
<th>Action</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ALLOW</code></td>
<td>Allow matching requests (default deny all others)</td>
</tr>
<tr>
<td><code>DENY</code></td>
<td>Deny matching requests</td>
</tr>
<tr>
<td><code>CUSTOM</code></td>
<td>Delegate to external authorizer</td>
</tr>
<tr>
<td><code>AUDIT</code></td>
<td>Audit matching requests (logging only)</td>
</tr>
</tbody>
</table>
<p><strong>Deny-All Policy (Zero Trust Baseline):</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">security.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AuthorizationPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deny-all</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">{}</span><span class="w">                                   </span><span class="c1"># Empty spec = deny all</span>
</code></pre></div>

<p><strong>Allow Specific Traffic:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">security.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AuthorizationPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">allow-productpage</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">productpage</span>
<span class="w">  </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ALLOW</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">from</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source</span><span class="p">:</span>
<span class="w">            </span><span class="nt">principals</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;cluster.local/ns/production/sa/frontend&quot;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">to</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">operation</span><span class="p">:</span>
<span class="w">            </span><span class="nt">methods</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;GET&quot;</span><span class="p p-Indicator">]</span>
<span class="w">            </span><span class="nt">paths</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;/api/*&quot;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">when</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">request.headers[x-token]</span>
<span class="w">          </span><span class="nt">values</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;valid-token&quot;</span><span class="p p-Indicator">]</span>
</code></pre></div>

<p>You will be thinking WTF is this? So I will start explain it now xD</p>
<p><code>principals</code> is SPIFFE ID (A SPIFFE ID is a string that uniquely and specifically identifies a workload)</p>
<div class="highlight"><pre><span></span><code>cluster.local/ns/production/sa/frontend
     │          │      │      │    │
     │          │      │      │    └── ServiceAccount name
     │          │      │      └── &quot;sa&quot; = service account
     │          │      └── Namespace name
     │          └── &quot;ns&quot; = namespace
     └── Trust domain (default cluster.local)
</code></pre></div>

<p>Read this rule by this following steps: Only allow request into pod <code>app: productpage</code> when</p>
<ul>
<li>from: client use serviceAccount <code>frontend</code> in namespace <code>production</code></li>
<li>to: Method <code>GET</code>, path <code>/api/*</code></li>
<li>when: Header <code>x-token: valid-token</code></li>
</ul>
<p>Those conditions are AND, if one not matching, then it will be denied.</p>
<p>Why use SPIFFE ID: because mTLS cert of each pod this identity, when traffic arrived, server sidecar extract identity from cert -&gt; match with <code>principals</code></p>
<p>Check identity of pod:</p>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">istioctl proxy-config secret &lt;pod&gt; -o json -n &lt;namespace&gt; | grep spiffe</span>
</code></pre></div>

<p>Short forms for exam:</p>
<div class="highlight"><pre><span></span><code><span class="nt">principals</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;cluster.local/ns/production/sa/frontend&quot;</span><span class="p p-Indicator">]</span><span class="w">  </span><span class="c1"># exact SA</span>
<span class="nt">principals</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;cluster.local/ns/production/sa/*&quot;</span><span class="p p-Indicator">]</span><span class="w">         </span><span class="c1"># any SA in ns</span>
<span class="nt">namespaces</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;production&quot;</span><span class="p p-Indicator">]</span><span class="w">                                </span><span class="c1"># simpler, same ns check</span>
</code></pre></div>

<p><strong>Deny Specific Traffic:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">security.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AuthorizationPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deny-bad-ips</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DENY</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">from</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source</span><span class="p">:</span>
<span class="w">            </span><span class="nt">ipBlocks</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;10.0.0.0/8&quot;</span><span class="p p-Indicator">]</span><span class="w"> </span><span class="c1"># Deny this</span>
<span class="w">            </span><span class="nt">notIpBlocks</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;10.0.1.0/24&quot;</span><span class="p p-Indicator">]</span><span class="w"> </span><span class="c1"># But except this xD (whitelist)</span>
</code></pre></div>

<p><strong>Policy Evaluation Order:</strong></p>
<div class="highlight"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">CUSTOM</span><span class="w"> </span><span class="n">policies</span><span class="w"> </span><span class="p">(</span><span class="kr">if</span><span class="w"> </span><span class="n">any</span><span class="p">)</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">DENY</span><span class="w"> </span><span class="n">policies</span><span class="w"> </span><span class="p">(</span><span class="kr">if</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">reject</span><span class="p">)</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">ALLOW</span><span class="w"> </span><span class="n">policies</span><span class="w"> </span><span class="p">(</span><span class="kr">if</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">allow</span><span class="p">)</span>
<span class="mf">4.</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="kr">on</span><span class="w"> </span><span class="n">whether</span><span class="w"> </span><span class="n">ALLOW</span><span class="w"> </span><span class="n">policies</span><span class="w"> </span><span class="n">exist</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="kr">If</span><span class="w"> </span><span class="n">ALLOW</span><span class="w"> </span><span class="n">policies</span><span class="w"> </span><span class="n">exist</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">deny</span><span class="w"> </span><span class="p">(</span><span class="n">allowlist</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="kr">If</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">ALLOW</span><span class="w"> </span><span class="n">policies</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="p">(</span><span class="n">no</span><span class="w"> </span><span class="n">restriction</span><span class="p">)</span>
</code></pre></div>

<blockquote>
<p><strong>References:</strong></p>
<ul>
<li><a href="https://istio.io/latest/docs/reference/config/security/authorization-policy/">Authorization Policy</a></li>
<li><a href="https://istio.io/latest/docs/concepts/security/#authorization">Authorization Concepts</a></li>
</ul>
</blockquote>
<hr>
<h3>7. RequestAuthentication (JWT Validation)</h3>
<p><em>Domain: Securing Workloads</em></p>
<p>Validate JWT tokens at the mesh edge. <code>RequestAuthentication</code> validate JWT token</p>
<p><strong>Basic JWT Validation:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">security.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RequestAuthentication</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jwt-auth</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">productpage</span>
<span class="w">  </span><span class="nt">jwtRules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">issuer</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://auth.example.com&quot;</span><span class="w"> </span><span class="c1"># JWT must have iss claim equal to this!</span>
<span class="w">      </span><span class="nt">jwksUri</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://auth.example.com/.well-known/jwks.json&quot;</span><span class="w"> </span><span class="c1"># Endpoint get public keys to verify signature</span>
<span class="w">      </span><span class="nt">audiences</span><span class="p">:</span><span class="w"> </span><span class="c1"># JWT must have `aud` claim match</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bookinfo-app&quot;</span>
<span class="w">      </span><span class="nt">forwardOriginalToken</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">       </span><span class="c1"># Forward JWT to upstream</span>
<span class="w">      </span><span class="nt">outputPayloadToHeader</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">x-jwt-payload</span><span class="w"> </span><span class="c1"># Decode payload -&gt; send into header x-jwt-payload</span>
</code></pre></div>

<p><strong>Multiple Issuers:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">security.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RequestAuthentication</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">multi-jwt</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">jwtRules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">issuer</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://accounts.google.com&quot;</span>
<span class="w">      </span><span class="nt">jwksUri</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://www.googleapis.com/oauth2/v3/certs&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">issuer</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://auth0.example.com/&quot;</span>
<span class="w">      </span><span class="nt">jwksUri</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://auth0.example.com/.well-known/jwks.json&quot;</span>
</code></pre></div>

<p><strong>Combine with AuthorizationPolicy:</strong> To enforce JWT, it must be combined with <code>AuthorizationPolicy</code></p>
<div class="highlight"><pre><span></span><code><span class="c1"># First: Validate JWT</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">security.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RequestAuthentication</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jwt-auth</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">productpage</span>
<span class="w">  </span><span class="nt">jwtRules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">issuer</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://auth.example.com&quot;</span>
<span class="w">      </span><span class="nt">jwksUri</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://auth.example.com/.well-known/jwks.json&quot;</span>
<span class="nn">---</span>
<span class="c1"># Then: Require valid JWT</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">security.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AuthorizationPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">require-jwt</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">productpage</span>
<span class="w">  </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ALLOW</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">from</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source</span><span class="p">:</span>
<span class="w">            </span><span class="nt">requestPrincipals</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;https://auth.example.com/*&quot;</span><span class="p p-Indicator">]</span><span class="w"> </span><span class="c1"># Must have valid JWT</span>
</code></pre></div>

<p>Exam Note: <code>RequestAuthentication</code> alone doesn't block requests not having JWT</p>
<ul>
<li>Have invalid JWT --&gt; 401!</li>
<li>Do not have JWT --&gt; Still pass! (RequestAuthentication alone is 'fail-open' - it only validates JWTs that ARE present, doesn't require them)</li>
</ul>
<blockquote>
<p><strong>Key Point:</strong> RequestAuthentication only <strong>validates</strong> tokens. To <strong>require</strong> tokens, combine with AuthorizationPolicy.</p>
<p><strong>References:</strong></p>
<ul>
<li><a href="https://istio.io/latest/docs/reference/config/security/request_authentication/">RequestAuthentication</a></li>
<li><a href="https://istio.io/latest/docs/tasks/security/authentication/authn-policy/#end-user-authentication">JWT Auth</a></li>
</ul>
</blockquote>
<hr>
<h3>8. Resilience Features</h3>
<p><em>Domain: Traffic Management</em></p>
<p>Build fault-tolerant services with Istio's resilience features.</p>
<p><strong>Circuit Breaker (Connection Pool + Outlier Detection):</strong></p>
<ul>
<li><code>connectionPool</code> (Connection/Request Volume Limits): Limits the number of concurrent connections and requests to the backend service.</li>
<li><code>outlierDetection</code> (Passive Health Checking / Ejection): Automatically ejects (removes) "unhealthy" or "faulty" pods from the load balancing pool.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DestinationRule</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews-cb</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="w">  </span><span class="nt">trafficPolicy</span><span class="p">:</span>
<span class="w">    </span><span class="nt">connectionPool</span><span class="p">:</span>
<span class="w">      </span><span class="nt">tcp</span><span class="p">:</span>
<span class="w">        </span><span class="nt">maxConnections</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span><span class="w">            </span><span class="c1"># Max TCP connections</span>
<span class="w">      </span><span class="nt">http</span><span class="p">:</span>
<span class="w">        </span><span class="nt">http1MaxPendingRequests</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span><span class="w">   </span><span class="c1"># Max pending HTTP/1.1 requests</span>
<span class="w">        </span><span class="nt">http2MaxRequests</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span><span class="w">         </span><span class="c1"># Max HTTP/2 requests</span>
<span class="w">        </span><span class="nt">maxRequestsPerConnection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w">   </span><span class="c1"># Requests per connection</span>
<span class="w">        </span><span class="nt">maxRetries</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span><span class="w">                  </span><span class="c1"># Max concurrent retries</span>
<span class="w">    </span><span class="nt">outlierDetection</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># Analyze every 10s, eject any pod with 5 consecutive 5xx errors for 30s, capping at 50% max ejections and disabling the mechanism if healthy pods drop below 30%.</span>
<span class="w">      </span><span class="nt">consecutive5xxErrors</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span><span class="w">          </span><span class="c1"># Eject after 5 consecutive 5xx</span>
<span class="w">      </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span><span class="w">                    </span><span class="c1"># Analysis interval</span>
<span class="w">      </span><span class="nt">baseEjectionTime</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30s</span><span class="w">            </span><span class="c1"># Min ejection time. First time, 1*30s, second time, 2*30s and so on....</span>
<span class="w">      </span><span class="c1"># This technique allows the system to automatically increase the ejection period for unhealthy upstream servers</span>
<span class="w">      </span><span class="c1"># https://istio.io/latest/docs/reference/config/networking/destination-rule/</span>
<span class="w">      </span><span class="nt">maxEjectionPercent</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50</span><span class="w">           </span><span class="c1"># Max % of pods to eject for example . If we have 2 pods, we can not eject larger than 1 pod!</span>
<span class="w">      </span><span class="nt">minHealthPercent</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w">             </span><span class="c1"># Min healthy hosts required</span>
</code></pre></div>

<p><strong>Retries:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VirtualService</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="w">  </span><span class="nt">http</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">route</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">destination</span><span class="p">:</span>
<span class="w">            </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="w">      </span><span class="nt">retries</span><span class="p">:</span>
<span class="w">        </span><span class="nt">attempts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span><span class="w">                    </span><span class="c1"># Max retry attempts</span>
<span class="w">        </span><span class="nt">perTryTimeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2s</span><span class="w">              </span><span class="c1"># Timeout per attempt</span>
<span class="w">        </span><span class="nt">retryOn</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;5xx,reset,connect-failure&quot;</span>
<span class="w">        </span><span class="nt">retryRemoteLocalities</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">    </span><span class="c1"># Retry on different locality</span>
</code></pre></div>

<p><strong>Timeouts:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VirtualService</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="w">  </span><span class="nt">http</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">route</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">destination</span><span class="p">:</span>
<span class="w">            </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="w">      </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span><span class="w">                     </span><span class="c1"># Total request timeout</span>
</code></pre></div>

<p><strong>Fault Injection (Testing Resilience):</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VirtualService</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
<span class="w">  </span><span class="nt">http</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">fault</span><span class="p">:</span>
<span class="w">        </span><span class="nt">delay</span><span class="p">:</span>
<span class="w">          </span><span class="nt">percentage</span><span class="p">:</span>
<span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w">                  </span><span class="c1"># 10% of requests</span>
<span class="w">          </span><span class="nt">fixedDelay</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5s</span><span class="w">               </span><span class="c1"># 5 second delay</span>
<span class="w">        </span><span class="nt">abort</span><span class="p">:</span>
<span class="w">          </span><span class="nt">percentage</span><span class="p">:</span>
<span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span><span class="w">                   </span><span class="c1"># 5% of requests</span>
<span class="w">          </span><span class="nt">httpStatus</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">503</span><span class="w">              </span><span class="c1"># Return 503</span>
<span class="w">      </span><span class="nt">route</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">destination</span><span class="p">:</span>
<span class="w">            </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviews</span>
</code></pre></div>

<p>There is some funny information about <code>value</code> of Fault Injection!</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Value (<code>percentage.value</code>)</th>
<th style="text-align: left;">Actual Percentage</th>
<th style="text-align: left;">Errors per 1,000 Requests</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>100</strong></td>
<td style="text-align: left;">100%</td>
<td style="text-align: left;">1,000</td>
<td style="text-align: left;"><strong>Total Failure:</strong> Every single request will fail.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>50</strong></td>
<td style="text-align: left;">50%</td>
<td style="text-align: left;">500</td>
<td style="text-align: left;"><strong>Even Split:</strong> Half of the requests will fail (1 in 2).</td>
</tr>
<tr>
<td style="text-align: left;"><strong>10</strong></td>
<td style="text-align: left;">10%</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;"><strong>Significant Impact:</strong> 1 in every 10 requests fails.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>1</strong></td>
<td style="text-align: left;">1%</td>
<td style="text-align: left;">10</td>
<td style="text-align: left;"><strong>Minor Impact:</strong> 1 in every 100 requests fails.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>0.5</strong></td>
<td style="text-align: left;">0.5%</td>
<td style="text-align: left;">5</td>
<td style="text-align: left;"><strong>Granular Testing:</strong> 5 in every 1,000 requests fail.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>0.1</strong></td>
<td style="text-align: left;">0.1%</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;"><strong>Subtle Testing:</strong> Only 1 in every 1,000 requests fails.</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>References:</strong></p>
<ul>
<li><a href="https://istio.io/latest/docs/tasks/traffic-management/circuit-breaking/">Circuit Breaking</a></li>
<li><a href="https://istio.io/latest/docs/tasks/traffic-management/fault-injection/">Fault Injection</a></li>
</ul>
</blockquote>
<hr>
<h3>9. ServiceEntry &amp; WorkloadEntry</h3>
<p><em>Domain: Traffic Management</em></p>
<p>Connect mesh services to external services or VMs. So it is pod virtualization for non-K8s workload, to apply mTLS, traffic policies like normal.</p>
<p><strong>ServiceEntry — Register External Services:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServiceEntry</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">external-api</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">api.external.com</span>
<span class="w">  </span><span class="nt">location</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MESH_EXTERNAL</span><span class="w">              </span><span class="c1"># Outside the mesh</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https</span>
<span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TLS</span>
<span class="w">  </span><span class="nt">resolution</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DNS</span><span class="w">                      </span><span class="c1"># DNS, STATIC, or NONE</span>
</code></pre></div>

<p><strong>ServiceEntry with Egress Gateway:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServiceEntry</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">external-api</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">api.external.com</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls</span>
<span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TLS</span>
<span class="w">  </span><span class="nt">resolution</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DNS</span>
<span class="w">  </span><span class="nt">location</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MESH_EXTERNAL</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VirtualService</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">external-api-route</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">api.external.com</span>
<span class="w">  </span><span class="nt">gateways</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mesh</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">istio-egressgateway</span>
<span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">gateways</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mesh</span>
<span class="w">          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
<span class="w">          </span><span class="nt">sniHosts</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">api.external.com</span>
<span class="w">      </span><span class="nt">route</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">destination</span><span class="p">:</span>
<span class="w">            </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">istio-egressgateway.istio-system.svc.cluster.local</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
</code></pre></div>

<p><strong>WorkloadEntry — Add VMs to Mesh:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">WorkloadEntry</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vm-workload</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.100</span><span class="w">               </span><span class="c1"># VM IP address</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">legacy-app</span>
<span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="w">  </span><span class="nt">serviceAccount</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">legacy-app-sa</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServiceEntry</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">legacy-app</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">legacy-app.example.com</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HTTP</span>
<span class="w">  </span><span class="nt">location</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MESH_INTERNAL</span>
<span class="w">  </span><span class="nt">resolution</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">STATIC</span>
<span class="w">  </span><span class="nt">workloadSelector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">legacy-app</span>
</code></pre></div>

<blockquote>
<p><strong>References:</strong></p>
<ul>
<li><a href="https://istio.io/latest/docs/reference/config/networking/service-entry/">ServiceEntry</a></li>
<li><a href="https://istio.io/latest/docs/reference/config/networking/workload-entry/">WorkloadEntry</a></li>
</ul>
</blockquote>
<hr>
<h3>10. Installation &amp; Upgrade</h3>
<p><em>Domain: Installation, Upgrade &amp; Configuration</em></p>
<p><strong>Installation Profiles:</strong></p>
<table>
<thead>
<tr>
<th>Profile</th>
<th>Use Case</th>
<th>Components</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>default</code></td>
<td>Production</td>
<td>istiod, ingress gateway</td>
</tr>
<tr>
<td><code>demo</code></td>
<td>Learning/Testing</td>
<td>All components, high tracing</td>
</tr>
<tr>
<td><code>minimal</code></td>
<td>Control plane only</td>
<td>istiod only</td>
</tr>
<tr>
<td><code>ambient</code></td>
<td>Ambient mode</td>
<td>ztunnel, CNI</td>
</tr>
<tr>
<td><code>empty</code></td>
<td>Custom builds</td>
<td>Nothing (start from scratch)</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="c1"># List available profiles</span>
istioctl<span class="w"> </span>profile<span class="w"> </span>list

<span class="c1"># Show profile configuration</span>
istioctl<span class="w"> </span>profile<span class="w"> </span>dump<span class="w"> </span>demo

<span class="c1"># Get configuration of specific profile with specific setting</span>
istioctl<span class="w"> </span>profile<span class="w"> </span>dump<span class="w"> </span>demo<span class="w"> </span>--config-path<span class="w"> </span>components.cni

<span class="c1"># Compare profiles</span>
istioctl<span class="w"> </span>profile<span class="w"> </span>diff<span class="w"> </span>default<span class="w"> </span>demo

<span class="c1"># Dump all resource that will be installed in YAML format for profile &#39;demo&#39;</span>
istioctl<span class="w"> </span>manifest<span class="w"> </span>generate<span class="w"> </span>--set<span class="w"> </span><span class="nv">profile</span><span class="o">=</span>demo
</code></pre></div>

<p><strong>Installation Methods:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Method 1: istioctl (recommended)</span>
istioctl<span class="w"> </span>install<span class="w"> </span>--set<span class="w"> </span><span class="nv">profile</span><span class="o">=</span>demo<span class="w"> </span>-y

<span class="c1"># Method 2: IstioOperator manifest</span>
istioctl<span class="w"> </span>install<span class="w"> </span>-f<span class="w"> </span>my-istio-config.yaml<span class="w"> </span><span class="c1"># resource kind: IstioOperator</span>

<span class="c1"># Method 3: Helm</span>
helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>istio<span class="w"> </span>https://istio-release.storage.googleapis.com/charts
helm<span class="w"> </span>install<span class="w"> </span>istio-base<span class="w"> </span>istio/base<span class="w"> </span>-n<span class="w"> </span>istio-system<span class="w"> </span>--create-namespace
helm<span class="w"> </span>install<span class="w"> </span>istiod<span class="w"> </span>istio/istiod<span class="w"> </span>-n<span class="w"> </span>istio-system
helm<span class="w"> </span>install<span class="w"> </span>istio-ingress<span class="w"> </span>istio/gateway<span class="w"> </span>-n<span class="w"> </span>istio-ingress<span class="w"> </span>--create-namespace

<span class="c1"># Verify installation</span>
istioctl<span class="w"> </span>verify-install

<span class="c1"># Check Istio version</span>
istioctl<span class="w"> </span>version

<span class="c1"># Display the parameters of the current installation</span>
kubectl<span class="w"> </span>get<span class="w"> </span>IstioOperator<span class="w"> </span>-n<span class="w"> </span>istio-system<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span>installed-state
</code></pre></div>

<p><strong>IstioOperator Custom Configuration:</strong> Define Istio config, need Istio installed already! You can imagine it as <code>values.yaml</code> of Helm</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install.istio.io/v1alpha1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IstioOperator</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">istio-control-plane</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">profile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">  </span><span class="nt">meshConfig</span><span class="p">:</span>
<span class="w">    </span><span class="nt">accessLogFile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/stdout</span><span class="w">         </span><span class="c1"># Enable access logs</span>
<span class="w">    </span><span class="nt">enableTracing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">defaultConfig</span><span class="p">:</span>
<span class="w">      </span><span class="nt">tracing</span><span class="p">:</span>
<span class="w">        </span><span class="nt">sampling</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100.0</span><span class="w">                </span><span class="c1"># 100% trace sampling</span>
<span class="w">  </span><span class="nt">components</span><span class="p">:</span>
<span class="w">    </span><span class="nt">ingressGateways</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">istio-ingressgateway</span>
<span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">        </span><span class="nt">k8s</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LoadBalancer</span>
<span class="w">          </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">            </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100m</span>
<span class="w">              </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">128Mi</span>
<span class="w">    </span><span class="nt">egressGateways</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">istio-egressgateway</span>
<span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">values</span><span class="p">:</span>
<span class="w">    </span><span class="nt">global</span><span class="p">:</span>
<span class="w">      </span><span class="nt">proxy</span><span class="p">:</span>
<span class="w">        </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">          </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50m</span>
<span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">64Mi</span>
</code></pre></div>

<p><strong>Upgrade Strategies:</strong></p>
<p><strong>In-Place Upgrade:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Download new version</span>
curl<span class="w"> </span>-L<span class="w"> </span>https://istio.io/downloadIstio<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">ISTIO_VERSION</span><span class="o">=</span><span class="m">1</span>.22.0<span class="w"> </span>sh<span class="w"> </span>-

<span class="c1"># Upgrade</span>
istioctl<span class="w"> </span>upgrade<span class="w"> </span>--set<span class="w"> </span><span class="nv">profile</span><span class="o">=</span>default

<span class="c1"># Restart workloads to get new sidecar</span>
kubectl<span class="w"> </span>rollout<span class="w"> </span>restart<span class="w"> </span>deployment<span class="w"> </span>-n<span class="w"> </span>&lt;namespace&gt;
</code></pre></div>

<p><strong>Canary Upgrade (Recommended for Production):</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Check system before installation</span>
istioctl<span class="w"> </span>x<span class="w"> </span>precheck
<span class="c1"># ✔ No issues found when checking the cluster. Istio is safe to install or upgrade!</span>
<span class="c1"># To get started, check out https://istio.io/latest/docs/setup/getting-started/</span>

<span class="c1"># Install new control plane with revision</span>
istioctl<span class="w"> </span>install<span class="w"> </span>--set<span class="w"> </span><span class="nv">revision</span><span class="o">=</span><span class="m">1</span>-22-0<span class="w"> </span>--set<span class="w"> </span><span class="nv">profile</span><span class="o">=</span>default

<span class="c1"># Label namespace to use new revision</span>
kubectl<span class="w"> </span>label<span class="w"> </span>namespace<span class="w"> </span>production<span class="w"> </span>istio.io/rev<span class="o">=</span><span class="m">1</span>-22-0<span class="w"> </span>--overwrite

<span class="c1"># Restart workloads</span>
kubectl<span class="w"> </span>rollout<span class="w"> </span>restart<span class="w"> </span>deployment<span class="w"> </span>-n<span class="w"> </span>production

<span class="c1"># After validation, remove old control plane</span>
istioctl<span class="w"> </span>uninstall<span class="w"> </span>--revision<span class="w"> </span><span class="m">1</span>-21-0
</code></pre></div>

<blockquote>
<p><strong>References:</strong></p>
<ul>
<li><a href="https://istio.io/latest/docs/setup/install/">Installation Guide</a></li>
<li><a href="https://istio.io/latest/docs/setup/upgrade/">Upgrade Guide</a></li>
</ul>
</blockquote>
<h3>11. What is WorkloadGroup?</h3>
<p>WorkloadGroup = Template to create WorkloadEntry, like Deployment for Pod xD</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">WorkloadGroup</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">legacy-app-group</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">legacy-app</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">serviceAccount</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">legacy-sa</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="nt">http</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</code></pre></div>

<p>Use case: If multiple VMs share the same role (such as auto-scaling VMs), instead of creating each WorkloadEntry individually, the VMs joining the mesh will automatically create WorkloadEntry based on this template. Often used with istio-agent on VMs for auto-registration.</p>
<hr>
<h1>Istio Resource Quick Reference</h1>
<h3>Traffic Management</h3>
<p><img alt="alt text" src="images/2025/12/41.png"></p>
<h3>Security</h3>
<p><img alt="alt text" src="images/2025/12/42.png"></p>
<h3>Troubleshooting</h3>
<p><img alt="alt text" src="images/2025/12/43.png"></p>
<hr>
<h1>Istio Resources Cheat Sheet</h1>
<h3>Traffic Management</h3>
<table>
<thead>
<tr>
<th>Kind</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>VirtualService</strong></td>
<td>WHERE - routing rules (host, path, headers → destination, retry, timeout, fault injection)</td>
</tr>
<tr>
<td><strong>DestinationRule</strong></td>
<td>HOW - policies after routing (subsets, LB algorithm, circuit breaker, connection pool, TLS)</td>
</tr>
<tr>
<td><strong>Gateway</strong></td>
<td>Entry/exit point for mesh (ingress/egress), define listeners + TLS</td>
</tr>
<tr>
<td><strong>ServiceEntry</strong></td>
<td>Register external service into mesh registry</td>
</tr>
<tr>
<td><strong>WorkloadEntry</strong></td>
<td>Register non-K8s workload (VM) into mesh</td>
</tr>
<tr>
<td><strong>WorkloadGroup</strong></td>
<td>Template for WorkloadEntry (like Deployment for Pod)</td>
</tr>
<tr>
<td><strong>Sidecar</strong></td>
<td>Config sidecar scope (limit egress hosts, reduce memory)</td>
</tr>
<tr>
<td><strong>ProxyConfig</strong></td>
<td>Tune Envoy proxy settings (concurrency, tracing)</td>
</tr>
</tbody>
</table>
<h3>Security</h3>
<table>
<thead>
<tr>
<th>Kind</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>PeerAuthentication</strong></td>
<td>Server-side mTLS policy (STRICT/PERMISSIVE/DISABLE)</td>
</tr>
<tr>
<td><strong>RequestAuthentication</strong></td>
<td>JWT validation (issuer, jwksUri, audiences)</td>
</tr>
<tr>
<td><strong>AuthorizationPolicy</strong></td>
<td>Access control (ALLOW/DENY/CUSTOM based on source, operation, conditions)</td>
</tr>
</tbody>
</table>
<h3>Key Combos</h3>
<p>This is pretty useful for you to remember what is used together and what is the reason to use.</p>
<table>
<thead>
<tr>
<th>Use Case</th>
<th>Resources</th>
<th>Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ingress</td>
<td><code>Gateway</code> + <code>VirtualService</code></td>
<td>Receive traffic from the internet and route it to internal services.</td>
</tr>
<tr>
<td>Egress</td>
<td><code>ServiceEntry</code> + <code>Gateway</code> + <code>VirtualService</code></td>
<td>Route traffic going out of the mesh through a dedicated Egress Gateway for security/auditing.</td>
</tr>
<tr>
<td>mTLS enforce</td>
<td><code>PeerAuthentication</code></td>
<td>Encrypt communication between pods and enforce Mutual TLS (Strict/Permissive).</td>
</tr>
<tr>
<td>JWT required</td>
<td><code>RequestAuthentication</code> + <code>AuthorizationPolicy</code></td>
<td>Validate JSON Web Tokens (JWT) and enforce access control based on token claims.</td>
</tr>
<tr>
<td>Traffic splitting</td>
<td><code>VirtualService</code> + <code>DestinationRule</code> (subsets)</td>
<td>Manage Canary Deployments or A/B testing by splitting traffic between subsets (v1/v2).</td>
</tr>
<tr>
<td>External VM</td>
<td><code>WorkloadEntry</code> + <code>ServiceEntry</code></td>
<td>Integrate non-Kubernetes workloads (VMs/Bare-metal) into the mesh as if they were pods.</td>
</tr>
<tr>
<td>Resilience</td>
<td><code>VirtualService</code> + <code>DestinationRule</code></td>
<td>Configure Circuit Breakers, Retries, Timeouts, and Outlier Detection to handle failures.</td>
</tr>
<tr>
<td>L7 Authz</td>
<td>AuthorizationPolicy</td>
<td>Enforce fine-grained Access Control (e.g., allow Service A to call GET on Service B but deny POST).</td>
</tr>
</tbody>
</table>
<hr>
<h1>Istio CLI Cheat Sheet</h1>
<p><em>Domain: Troubleshooting</em></p>
<p>Essential <code>istioctl</code> commands for the exam.</p>
<p><strong>Debug &amp; Logging:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Enable debug logging on proxy</span>
istioctl<span class="w"> </span>proxy-config<span class="w"> </span>log<span class="w"> </span>&lt;pod-name&gt;<span class="w"> </span>--level<span class="w"> </span>debug

<span class="c1"># Enable specific component logging</span>
istioctl<span class="w"> </span>proxy-config<span class="w"> </span>log<span class="w"> </span>&lt;pod-name&gt;<span class="w"> </span>--level<span class="w"> </span>connection:debug,http:debug

<span class="c1"># View Envoy access logs (in pod)</span>
kubectl<span class="w"> </span>logs<span class="w"> </span>&lt;pod-name&gt;<span class="w"> </span>-c<span class="w"> </span>istio-proxy<span class="w"> </span>-f

<span class="c1"># Describe proxy (detailed info)</span>
istioctl<span class="w"> </span>experimental<span class="w"> </span>describe<span class="w"> </span>pod<span class="w"> </span>&lt;pod-name&gt;
</code></pre></div>

<p><strong>Injection &amp; Labeling:</strong> Be sure to remember and understand this for exam plz!</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Check if namespace has auto-injection enabled</span>
kubectl<span class="w"> </span>get<span class="w"> </span>namespace<span class="w"> </span>-L<span class="w"> </span>istio-injection

<span class="c1"># Enable auto-injection</span>
kubectl<span class="w"> </span>label<span class="w"> </span>namespace<span class="w"> </span>&lt;ns&gt;<span class="w"> </span>istio-injection<span class="o">=</span>enabled

<span class="c1"># Disable auto-injection</span>
kubectl<span class="w"> </span>label<span class="w"> </span>namespace<span class="w"> </span>&lt;ns&gt;<span class="w"> </span>istio-injection-

<span class="c1"># Manual injection</span>
istioctl<span class="w"> </span>kube-inject<span class="w"> </span>-f<span class="w"> </span>deployment.yaml<span class="w"> </span><span class="p">|</span><span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>-

<span class="c1"># Check injection status</span>
istioctl<span class="w"> </span>experimental<span class="w"> </span>check-inject<span class="w"> </span>-n<span class="w"> </span>&lt;namespace&gt;
</code></pre></div>

<p><strong>Common Troubleshooting Scenarios:</strong></p>
<table>
<thead>
<tr>
<th>Symptom</th>
<th>Command</th>
<th>What to Check</th>
</tr>
</thead>
<tbody>
<tr>
<td>503 errors</td>
<td><code>istioctl proxy-config clusters</code></td>
<td>Cluster health, endpoints</td>
</tr>
<tr>
<td>Routing not working</td>
<td><code>istioctl proxy-config routes</code></td>
<td>VirtualService applied correctly</td>
</tr>
<tr>
<td>Config not applied</td>
<td><code>istioctl analyze</code></td>
<td>Configuration errors</td>
</tr>
<tr>
<td>Still like above but with namespace xD</td>
<td><code>istioctl analyze -n default-namespace</code></td>
<td>Configuration errors</td>
</tr>
<tr>
<td>Sidecar not injected</td>
<td><code>kubectl get pod -o yaml</code></td>
<td>Injection labels</td>
</tr>
</tbody>
</table>
<p>After applying the manifest every time, I would run <code>istioctl analyze</code> to check if there were any issues.</p>
<blockquote>
<p><strong>References:</strong></p>
<ul>
<li><a href="https://istio.io/latest/docs/reference/commands/istioctl/">istioctl Reference</a></li>
<li><a href="https://istio.io/latest/docs/ops/diagnostic-tools/">Troubleshooting Guide</a></li>
</ul>
</blockquote>
<h3>Dashboards (Quick Access to Observability UIs)</h3>
<table>
<thead>
<tr>
<th>Command</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>istioctl dashboard kiali</code></td>
<td>Open Kiali (service graph, mesh observability)</td>
</tr>
<tr>
<td><code>istioctl dashboard grafana</code></td>
<td>Open Grafana (metrics dashboards)</td>
</tr>
<tr>
<td><code>istioctl dashboard jaeger</code></td>
<td>Open Jaeger (distributed tracing)</td>
</tr>
<tr>
<td><code>istioctl dashboard envoy &lt;pod&gt;</code></td>
<td>Open Envoy admin UI for specific pod</td>
</tr>
</tbody>
</table>
<h3>Upgrade &amp; Uninstall</h3>
<table>
<thead>
<tr>
<th>Command</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>istioctl upgrade</code></td>
<td>In-place upgrade Istio to new version</td>
</tr>
<tr>
<td><code>istioctl install --set revision=&lt;rev&gt;</code></td>
<td>Canary upgrade with revision label (e.g., 1-20-0)</td>
</tr>
<tr>
<td><code>istioctl uninstall --revision &lt;rev&gt;</code></td>
<td>Remove specific revision</td>
</tr>
<tr>
<td><code>istioctl uninstall --purge</code></td>
<td>Complete removal of Istio</td>
</tr>
</tbody>
</table>
<hr>
<h1>Key Resources</h1>
<ul>
<li><a href="https://istio.io/latest/docs/">Istio Official Documentation</a></li>
<li><a href="https://training.linuxfoundation.org/certification/istio-certified-associate-ica/">ICA Exam Curriculum</a></li>
<li><a href="https://github.com/istio/istio/tree/master/samples">Istio GitHub Examples</a></li>
</ul>
<hr>
<h1>Exam Notes</h1>
<p>Don't be like me, I was thinking this exam was a quiz choice, not hands-on. And then you know what happens, I failed 1st time. My mistake was that I didn't check the exam before scheduling xD. But luckily Linux Foundation gives 1 free retry.</p>
<h3>Where to practice</h3>
<p>Killercoda fore sure!</p>
<ul>
<li>Recommended: <a href="https://killercoda.com/ica-scenarios">ICA Certification | Killercoda</a></li>
<li><a href="https://killercoda.com/istio">Istio | Killercoda</a></li>
<li>Recommended: <a href="https://killercoda.com/ica">Killercoda Interactive Environments</a></li>
<li><a href="https://istioworkshop.github.io/">Istioworkshop.github.io</a></li>
<li>Free resource for learning: <a href="https://academy.tetrate.io/courses/take/istio-fundamentals/lessons/19935842-1-0-module-overview">Tetrate</a></li>
</ul>
<h3>Practice Istio Installation</h3>
<p>Scenario: Install Istio version 1.21.0 on a Kubernetes cluster using istioctl.
Requirements:</p>
<ul>
<li>Download Istio version 1.21.0</li>
<li>Install Istio using <code>demo</code> profile</li>
<li>Enable sidecar injection for <code>production</code> namespace</li>
<li>Deploy a test application httpbin in <code>production</code> namespace</li>
<li>Verify Istio installation and sidecar injection</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Step 1: Download Istio 1.21.0</span>
curl<span class="w"> </span>-L<span class="w"> </span>https://istio.io/downloadIstio<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">ISTIO_VERSION</span><span class="o">=</span><span class="m">1</span>.21.0<span class="w"> </span>sh<span class="w"> </span>-

<span class="c1"># Step 2: Add istioctl to PATH</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PWD</span>/istio-1.21.0/bin:<span class="nv">$PATH</span>

<span class="c1"># Step 3: Verify istioctl</span>
istioctl<span class="w"> </span>version<span class="w"> </span>--remote<span class="o">=</span><span class="nb">false</span>

<span class="c1"># Step 4: Install Istio with demo profile</span>
istioctl<span class="w"> </span>install<span class="w"> </span>--set<span class="w"> </span><span class="nv">profile</span><span class="o">=</span>demo<span class="w"> </span>-y

<span class="c1"># Step 5: Verify installation</span>
istioctl<span class="w"> </span>verify-install
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>istio-system

<span class="c1"># Step 6: Create and label production namespace</span>
kubectl<span class="w"> </span>create<span class="w"> </span>namespace<span class="w"> </span>production
kubectl<span class="w"> </span>label<span class="w"> </span>namespace<span class="w"> </span>production<span class="w"> </span>istio-injection<span class="o">=</span>enabled

<span class="c1"># Step 7: Deploy test app</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>istio-1.21.0/samples/sleep/sleep.yaml<span class="w"> </span>-n<span class="w"> </span>production

<span class="c1"># Step 8: Verify sidecar injection (2/2 containers)</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>production
<span class="c1"># Expected: sleep-xxx  2/2  Running</span>
</code></pre></div>

<h3>Practice Canary Upgrade Istio</h3>
<p>Scenario: Upgrade Istio from <code>1.21.0</code> to <code>1.22.0</code> using canary method.
Pre-requisites: Lab 1 completed (Istio <code>1.21.0</code> running)
Requirements:</p>
<ul>
<li>Download Istio version <code>1.22.0</code></li>
<li>Install new control plane with revision <code>1-22-0</code> using <code>demo</code> profile</li>
<li>Migrate <code>production</code> namespace to new revision</li>
<li>Restart workloads and verify sync status</li>
<li>Uninstall old control plane</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Step 1: Download Istio 1.22.0</span>
curl<span class="w"> </span>-L<span class="w"> </span>https://istio.io/downloadIstio<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">ISTIO_VERSION</span><span class="o">=</span><span class="m">1</span>.22.0<span class="w"> </span>sh<span class="w"> </span>-
<span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PWD</span>/istio-1.22.0/bin:<span class="nv">$PATH</span>

<span class="c1"># Step 2: Install new control plane with revision</span>
istioctl<span class="w"> </span>install<span class="w"> </span>--set<span class="w"> </span><span class="nv">revision</span><span class="o">=</span><span class="m">1</span>-22-0<span class="w"> </span>--set<span class="w"> </span><span class="nv">profile</span><span class="o">=</span>demo<span class="w"> </span>-y

<span class="c1"># Step 3: Verify 2 istiod running</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>istio-system<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>istiod
<span class="c1"># Expected: istiod-xxxxx (old) + istiod-1-22-0-xxxxx (new)</span>

<span class="c1"># Step 4: Relabel production namespace</span>
kubectl<span class="w"> </span>label<span class="w"> </span>namespace<span class="w"> </span>production<span class="w"> </span>istio-injection-
kubectl<span class="w"> </span>label<span class="w"> </span>namespace<span class="w"> </span>production<span class="w"> </span>istio.io/rev<span class="o">=</span><span class="m">1</span>-22-0

<span class="c1"># Step 5: Restart workloads</span>
kubectl<span class="w"> </span>rollout<span class="w"> </span>restart<span class="w"> </span>deployment<span class="w"> </span>-n<span class="w"> </span>production

<span class="c1"># Step 6: Verify proxies sync with new control plane</span>
istioctl<span class="w"> </span>proxy-status
<span class="c1"># Expected: All showing &quot;istiod-1-22-0&quot;</span>

<span class="c1"># Step 7: Uninstall old control plane</span>
istioctl<span class="w"> </span>uninstall<span class="w"> </span>--revision<span class="w"> </span>default<span class="w"> </span>-y

<span class="c1"># Step 8: Final verification</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>istio-system<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>istiod
<span class="c1"># Expected: only 1 istiod-1-22-0 xD</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>istio-system
istioctl<span class="w"> </span>version
</code></pre></div>

<p>Remember to uninstall it to retest xD: <code>istioctl uninstall --purge -y &amp;&amp; rm -rf istio-1.2*</code></p>
<p>Document page for the exam: <a href="https://istio.io/latest/docs/setup/upgrade/canary/">https://istio.io/latest/docs/setup/upgrade/canary/</a></p>
<hr>
<h1>Comparison: Istio vs Haproxy</h1>
<p>If we are simply using Istio for request routing, it would be called over-engineering. So, when to use Istio:</p>
<ul>
<li>Fault Injection: Simulate 503 or delay 5s to test the app's fault tolerance</li>
<li>Circuit Breaking: Auto-disconnect traffic to fucked Pod to prevent domino?</li>
<li>Mirroring: Fire and forget traffic to the beta version without affecting the live version! </li>
</ul>


             
 
            
            
            







            <hr/>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2025-12-31T00:00:00+07:00">Wed 31 December 2025</time>
            <h4>Category</h4>
            <a class="category-link" href="https://blackmetalz.github.io/categories.html#knowledge-base-ref">Knowledge Base</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="https://blackmetalz.github.io/tags.html#certification-ref">certification
                    <span class="superscript">9</span>
</a></li>
                <li><a href="https://blackmetalz.github.io/tags.html#ica-ref">ica
                    <span class="superscript">1</span>
</a></li>
                <li><a href="https://blackmetalz.github.io/tags.html#istio-ref">istio
                    <span class="superscript">1</span>
</a></li>
                <li><a href="https://blackmetalz.github.io/tags.html#linux-foundation-ref">linux-foundation
                    <span class="superscript">8</span>
</a></li>
                <li><a href="https://blackmetalz.github.io/tags.html#service-mesh-ref">service-mesh
                    <span class="superscript">1</span>
</a></li>
            </ul>
<h4>Contact</h4>
<div id="sidebar-social-link">
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="https://blackmetalz.github.io/theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>